<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadowverse Tracker - çŸ©é™£è¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #1a1a2e;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        pre {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .data-table th, .data-table td {
            border: 1px solid #444;
            padding: 8px;
            text-align: center;
        }
        .data-table th {
            background: #333;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Shadowverse Tracker - çŸ©é™£è¨ºæ–·å·¥å…·</h1>
        
        <div class="debug-section">
            <h3>ğŸ“‹ æ•¸æ“šè¼‰å…¥</h3>
            <input type="file" id="dataFile" accept=".json">
            <button onclick="loadTestData()">è¼‰å…¥æ¸¬è©¦æ•¸æ“š</button>
            <p id="loadStatus">è«‹é¸æ“‡æ•¸æ“šæ–‡ä»¶...</p>
        </div>

        <div class="debug-section">
            <h3>ğŸ“Š åŸºæœ¬çµ±è¨ˆ</h3>
            <div id="basicStats"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ¯ å…ˆæ‰‹/å¾Œæ‰‹åˆ†å¸ƒ</h3>
            <div id="turnOrderStats"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ”´ å…ˆæ‰‹çŸ©é™£æ•¸æ“š</h3>
            <div id="firstHandMatrix"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ”µ å¾Œæ‰‹çŸ©é™£æ•¸æ“š</h3>
            <div id="secondHandMatrix"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ” åŸå§‹æ•¸æ“šæ¨£æœ¬</h3>
            <div id="rawDataSample"></div>
        </div>
    </div>

    <script>
        const CLASS_LIST = ['çš‡å®¶', 'ç²¾éˆ', 'å·«å¸«', 'é¾', 'å¤œé­”', 'ä¸»æ•™', 'å¾©ä»‡è€…'];
        let battleData = [];

        document.getElementById('dataFile').addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    battleData = data.battleData || [];
                    document.getElementById('loadStatus').textContent = `âœ… å·²è¼‰å…¥ ${battleData.length} ç­†å°æˆ°è¨˜éŒ„`;
                    analyzeData();
                } catch (error) {
                    document.getElementById('loadStatus').textContent = `âŒ è¼‰å…¥å¤±æ•—: ${error.message}`;
                }
            };
            reader.readAsText(file);
        }

        function loadTestData() {
            // å‰µå»ºæ¸¬è©¦æ•¸æ“š
            battleData = [
                { myClass: 'å¾©ä»‡è€…', opponentClass: 'ç²¾éˆ', turnOrder: 'å…ˆæ‰‹', result: 'å‹' },
                { myClass: 'å¾©ä»‡è€…', opponentClass: 'ç²¾éˆ', turnOrder: 'å¾Œæ‰‹', result: 'æ•—' },
                { myClass: 'ç²¾éˆ', opponentClass: 'é¾', turnOrder: 'å…ˆæ‰‹', result: 'å‹' },
                { myClass: 'ç²¾éˆ', opponentClass: 'é¾', turnOrder: 'å¾Œæ‰‹', result: 'å‹' },
                { myClass: 'é¾', opponentClass: 'å¾©ä»‡è€…', turnOrder: 'å…ˆæ‰‹', result: 'æ•—' },
                { myClass: 'é¾', opponentClass: 'å¾©ä»‡è€…', turnOrder: 'å¾Œæ‰‹', result: 'å‹' }
            ];
            document.getElementById('loadStatus').textContent = `âœ… å·²è¼‰å…¥æ¸¬è©¦æ•¸æ“š ${battleData.length} ç­†`;
            analyzeData();
        }

        function analyzeData() {
            showBasicStats();
            showTurnOrderStats();
            analyzeMatrix();
            showRawDataSample();
        }

        function showBasicStats() {
            const total = battleData.length;
            const withTurnOrder = battleData.filter(b => b.turnOrder).length;
            const validClasses = battleData.filter(b => 
                CLASS_LIST.includes(b.myClass) && CLASS_LIST.includes(b.opponentClass)
            ).length;

            document.getElementById('basicStats').innerHTML = `
                <p><strong>ç¸½å°æˆ°è¨˜éŒ„:</strong> ${total} ç­†</p>
                <p><strong>æœ‰å…ˆæ‰‹/å¾Œæ‰‹è³‡è¨Š:</strong> ${withTurnOrder} ç­† (${((withTurnOrder/total)*100).toFixed(1)}%)</p>
                <p><strong>è·æ¥­åç¨±æœ‰æ•ˆ:</strong> ${validClasses} ç­†</p>
            `;
        }

        function showTurnOrderStats() {
            const firstHand = battleData.filter(b => b.turnOrder === 'å…ˆæ‰‹').length;
            const secondHand = battleData.filter(b => b.turnOrder === 'å¾Œæ‰‹').length;
            const noTurnOrder = battleData.filter(b => !b.turnOrder).length;

            document.getElementById('turnOrderStats').innerHTML = `
                <p><strong>å…ˆæ‰‹:</strong> ${firstHand} ç­†</p>
                <p><strong>å¾Œæ‰‹:</strong> ${secondHand} ç­†</p>
                <p><strong>ç„¡å…ˆæ‰‹/å¾Œæ‰‹è³‡è¨Š:</strong> ${noTurnOrder} ç­†</p>
            `;
        }

        function analyzeMatrix() {
            const matrix = getMatrixStatistics();
            
            renderMatrixDebug('firstHandMatrix', matrix.first, 'å…ˆæ‰‹');
            renderMatrixDebug('secondHandMatrix', matrix.second, 'å¾Œæ‰‹');
        }

        function getMatrixStatistics() {
            const matrix = {
                first: {},
                second: {}
            };

            // åˆå§‹åŒ–çŸ©é™£
            CLASS_LIST.forEach(myClass => {
                matrix.first[myClass] = {};
                matrix.second[myClass] = {};
                CLASS_LIST.forEach(opponentClass => {
                    matrix.first[myClass][opponentClass] = { wins: 0, total: 0, winRate: 0 };
                    matrix.second[myClass][opponentClass] = { wins: 0, total: 0, winRate: 0 };
                });
            });

            // çµ±è¨ˆå°æˆ°æ•¸æ“š
            battleData.forEach(battle => {
                const { myClass, opponentClass, result, turnOrder } = battle;
                
                if (!turnOrder || !CLASS_LIST.includes(myClass) || !CLASS_LIST.includes(opponentClass)) {
                    return;
                }

                const turnMatrix = turnOrder === 'å…ˆæ‰‹' ? matrix.first : matrix.second;
                
                if (turnMatrix[myClass] && turnMatrix[myClass][opponentClass]) {
                    turnMatrix[myClass][opponentClass].total++;
                    if (result === 'å‹') {
                        turnMatrix[myClass][opponentClass].wins++;
                    }
                    
                    const total = turnMatrix[myClass][opponentClass].total;
                    const wins = turnMatrix[myClass][opponentClass].wins;
                    turnMatrix[myClass][opponentClass].winRate = total > 0 ? Math.round((wins / total) * 100) : 0;
                }
            });

            return matrix;
        }

        function renderMatrixDebug(containerId, matrixData, turnType) {
            let html = `<h4>${turnType}çŸ©é™£æ•¸æ“š</h4>`;
            html += '<table class="data-table">';
            html += '<tr><th>æˆ‘æ–¹\\å°æ‰‹</th>';
            CLASS_LIST.forEach(cls => html += `<th>${cls}</th>`);
            html += '</tr>';

            let totalGames = 0;
            CLASS_LIST.forEach(myClass => {
                html += `<tr><td><strong>${myClass}</strong></td>`;
                CLASS_LIST.forEach(opponentClass => {
                    const data = matrixData[myClass][opponentClass];
                    totalGames += data.total;
                    const cellColor = data.total > 0 ? (data.winRate >= 50 ? '#4CAF50' : '#f44336') : '#666';
                    html += `<td style="background: ${cellColor};">
                        ${data.total > 0 ? `${data.winRate}%<br>(${data.wins}/${data.total})` : '--'}
                    </td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            html += `<p><strong>ç¸½å ´æ¬¡:</strong> ${totalGames} å ´</p>`;

            document.getElementById(containerId).innerHTML = html;
        }

        function showRawDataSample() {
            const sample = battleData.slice(0, 10);
            let html = '<h4>å‰10ç­†æ•¸æ“šæ¨£æœ¬</h4>';
            html += '<table class="data-table">';
            html += '<tr><th>æˆ‘æ–¹è·æ¥­</th><th>å°æ‰‹è·æ¥­</th><th>å…ˆæ‰‹/å¾Œæ‰‹</th><th>çµæœ</th></tr>';
            
            sample.forEach(battle => {
                html += `<tr>
                    <td>${battle.myClass || 'N/A'}</td>
                    <td>${battle.opponentClass || 'N/A'}</td>
                    <td>${battle.turnOrder || 'N/A'}</td>
                    <td>${battle.result || 'N/A'}</td>
                </tr>`;
            });
            
            html += '</table>';
            document.getElementById('rawDataSample').innerHTML = html;
        }
    </script>
</body>
</html>
