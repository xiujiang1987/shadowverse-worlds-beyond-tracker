<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—‡å½±è©©ç« ï¼šå‡Œè¶Šä¸–ç•Œ (Shadowverse: Worlds Beyond) - å°æˆ°ç´€éŒ„APP</title>
    <style>
/* Shadowverse: Worlds Beyond Tracker - ä¸»æ¨£å¼æ–‡ä»¶ */

/* åŸºç¤é‡ç½®èˆ‡å…¨åŸŸæ¨£å¼ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Microsoft JhengHei', Arial, sans-serif;
    background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
    color: #fff;
    min-height: 100vh;
    padding: 20px;
}

/* å®¹å™¨èˆ‡ä½ˆå±€ */
.container {
    max-width: 800px;
    margin: 0 auto;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 30px;
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

/* é ­éƒ¨å€åŸŸ */
.header {
    text-align: center;
    margin-bottom: 30px;
}

.header h1 {
    color: #ffd700;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    margin-bottom: 10px;
}

/* å°èˆªé¸å–® */
.nav-menu {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.nav-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 215, 0, 0.3);
    padding: 10px 20px;
    border-radius: 25px;
    color: #fff;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
}

.nav-btn:hover {
    background: rgba(255, 215, 0, 0.2);
    border-color: #ffd700;
    transform: translateY(-2px);
}

.nav-btn.active {
    background: linear-gradient(45deg, #ffd700, #ffb300);
    border-color: #ffd700;
    color: #000;
}

/* é¢æ¿ç³»çµ± */
.panel {
    display: none;
}

.panel.active {
    display: block;
}

/* çµ±è¨ˆé¢æ¿ */
.stats-panel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: rgba(255, 255, 255, 0.15);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.stat-title {
    font-size: 14px;
    color: #ccc;
    margin-bottom: 10px;
}

.stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #ffd700;
}

/* ç©å®¶è³‡æ–™é¢æ¿ */
.player-profile {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 30px;
}

.profile-section {
    margin-bottom: 25px;
}

.profile-section h3 {
    color: #ffd700;
    margin-bottom: 15px;
    border-bottom: 2px solid rgba(255, 215, 0, 0.3);
    padding-bottom: 10px;
}

.profile-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
}

.profile-item {
    background: rgba(255, 255, 255, 0.15);
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #ffd700;
}

.profile-label {
    color: #ccc;
    font-size: 14px;
    margin-bottom: 5px;
}

.profile-value {
    color: #fff;
    font-size: 16px;
    font-weight: bold;
}

.profile-value.editable {
    cursor: pointer;
    transition: all 0.3s;
}

.profile-value.editable:hover {
    color: #ffd700;
    transform: scale(1.05);
}

/* è¡¨å–®å…ƒç´  */
.battle-form {
    background: rgba(255, 255, 255, 0.1);
    padding: 25px;
    border-radius: 10px;
    margin-bottom: 30px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #ffd700;
    font-weight: bold;
}

.form-group select, .form-group input {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
    font-size: 16px;
    transition: all 0.3s ease;
}

.form-group select:focus, .form-group input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

/* è¼¸å…¥é©—è­‰æ¨£å¼ */
.form-group input.error {
    border: 2px solid #ff4444;
    background: rgba(255, 68, 68, 0.2);
    animation: shake 0.5s ease-in-out;
}

.form-group input.warning {
    border: 2px solid #ffa500;
    background: rgba(255, 165, 0, 0.2);
}

.form-group input.success {
    border: 2px solid #4caf50;
    background: rgba(76, 175, 80, 0.2);
}

/* æ–å‹•å‹•ç•« */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

/* Toast é€šçŸ¥æ¨£å¼ */
.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    z-index: 1000;
    transform: translateX(300px);
    transition: transform 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.toast.show {
    transform: translateX(0);
}

.toast-success {
    background: linear-gradient(45deg, #4caf50, #8bc34a);
}

.toast-error {
    background: linear-gradient(45deg, #f44336, #ff6b6b);
}

.toast-warning {
    background: linear-gradient(45deg, #ff9800, #ffc107);
}

.toast-info {
    background: linear-gradient(45deg, #2196f3, #03a9f4);
}

.form-group select option {
    background: #1a1a2e;
    color: #fff;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 15px;
}

/* æŒ‰éˆ•æ¨£å¼ */
.btn {
    background: linear-gradient(45deg, #ff6b6b, #ffd700);
    border: none;
    padding: 15px 30px;
    border-radius: 25px;
    color: #fff;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    margin-top: 20px;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
}

.clear-btn {
    background: linear-gradient(45deg, #666, #999);
    margin-top: 10px;
}

.export-btn {
    background: linear-gradient(45deg, #00bcd4, #4dd0e1);
    margin-top: 10px;
}

.import-btn {
    background: linear-gradient(45deg, #ff9800, #ffb74d);
    margin-top: 10px;
}

/* å°æˆ°æ­·å² */
.battle-history {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    max-height: 400px;
    overflow-y: auto;
}

.battle-item {
    padding: 15px 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
}

.battle-item:last-child {
    border-bottom: none;
}

.battle-info {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
}

.battle-result {
    padding: 5px 15px;
    border-radius: 15px;
    font-weight: bold;
    margin-left: 15px;
}

.win {
    background: linear-gradient(45deg, #4CAF50, #81C784);
}

.lose {
    background: linear-gradient(45deg, #f44336, #e57373);
}

.bp-change {
    color: #ffd700;
    font-weight: bold;
}

/* å…ˆæ‰‹å¾Œæ‰‹æ¨£å¼ */
.turn-order {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: bold;
    margin: 0 4px;
}

.turn-order.å…ˆæ‰‹ {
    background: linear-gradient(45deg, #FF6B6B, #FF8E53);
    color: white;
}

.turn-order.å¾Œæ‰‹ {
    background: linear-gradient(45deg, #4ECDC4, #44A08D);
    color: white;
}

/* è·æ¥­åœ–æ¨™ */
.èŒä¸š-icon {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    margin-right: 8px;
}

.çš‡å®¶ { background: #FFD700; color: #000; }
.ç²¾éˆ { background: #228B22; color: #fff; }
.å·«å¸« { background: #4169E1; color: #fff; }
.é¾ { background: #DC143C; color: #fff; }
.å¤œé­” { background: linear-gradient(45deg, #8B008B, #8B0000); color: #fff; }
.ä¸»æ•™ { background: #F0E68C; color: #000; }
.å¾©ä»‡è€… { background: #2F4F4F; color: #fff; }

/* éšç´šè¨ˆç®—å™¨ */
.rank-calculator {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 25px;
    margin: 20px 0;
}

.rank-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.rank-card {
    background: rgba(255, 255, 255, 0.15);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.rank-title {
    color: #ffd700;
    font-weight: bold;
    margin-bottom: 10px;
}

.rank-requirement {
    color: #ccc;
    font-size: 14px;
    line-height: 1.4;
}

.rank-status {
    background: rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
}

.progress-bar {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    height: 20px;
    margin: 10px 0;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(45deg, #4CAF50, #81C784);
    transition: width 0.3s ease;
}

.rank-danger {
    color: #ff6b6b;
}

.rank-safe {
    color: #4CAF50;
}

.rank-warning {
    color: #ffa726;
}

/* æ•¸æ“šåŒæ­¥åŠŸèƒ½ */
.sync-section {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    border: 2px solid rgba(255, 215, 0, 0.3);
}

.sync-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.sync-btn {
    background: linear-gradient(45deg, #4CAF50, #81C784);
    border: none;
    padding: 15px 20px;
    border-radius: 10px;
    color: #fff;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.sync-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
}

.sync-btn.screenshot {
    background: linear-gradient(45deg, #2196F3, #64B5F6);
}

.sync-btn.voice {
    background: linear-gradient(45deg, #FF9800, #FFB74D);
}

.sync-btn.quick {
    background: linear-gradient(45deg, #9C27B0, #BA68C8);
}

/* åŒ¯å…¥å€åŸŸ */
.import-area {
    background: rgba(255, 255, 255, 0.1);
    border: 2px dashed rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
    text-align: center;
    transition: all 0.3s ease;
}

.import-area:hover {
    border-color: #ffd700;
    background: rgba(255, 215, 0, 0.1);
}

.import-area.dragover {
    border-color: #4CAF50;
    background: rgba(76, 175, 80, 0.2);
}

.file-input {
    display: none;
}

/* å°æˆ°çŸ©é™£æ¨£å¼ */
.matrix-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.matrix-toggle {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 30px;
}

.matrix-btn {
    padding: 12px 24px;
    border: 2px solid #444;
    background: rgba(0, 0, 0, 0.3);
    color: #ccc;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: bold;
}

.matrix-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: #666;
}

.matrix-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: #667eea;
    color: white;
}

.matrix-table-container {
    display: none;
    margin-bottom: 30px;
}

.matrix-table-container.active {
    display: block;
}

.matrix-table {
    margin-bottom: 25px;
    overflow-x: auto;
}

.matrix-table-content {
    width: 100%;
    border-collapse: collapse;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 10px;
    overflow: hidden;
    min-width: 700px;
}

.matrix-table-content th,
.matrix-table-content td {
    padding: 10px 8px;
    text-align: center;
    border: 1px solid #444;
    font-size: 13px;
}

.matrix-header-corner {
    background: linear-gradient(135deg, #434343 0%, #000000 100%);
    color: #ffd700;
    font-weight: bold;
    position: sticky;
    left: 0;
    z-index: 3;
}

.matrix-header {
    background: linear-gradient(135deg, #434343 0%, #2c2c2c 100%);
    color: #ffd700;
    font-weight: bold;
    writing-mode: vertical-rl;
    text-orientation: mixed;
    min-width: 45px;
}

.matrix-row-header {
    background: linear-gradient(135deg, #434343 0%, #2c2c2c 100%);
    color: #ffd700;
    font-weight: bold;
    position: sticky;
    left: 0;
    z-index: 2;
    min-width: 80px;
}

.matrix-cell {
    background: rgba(0, 0, 0, 0.3);
    color: #ccc;
    transition: all 0.3s ease;
    cursor: help;
    min-width: 45px;
}

.matrix-cell:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: scale(1.05);
}

.high-winrate {
    background: rgba(76, 175, 80, 0.3) !important;
    color: #4CAF50 !important;
    font-weight: bold;
}

.medium-winrate {
    background: rgba(255, 193, 7, 0.3) !important;
    color: #FFC107 !important;
    font-weight: bold;
}

.low-winrate {
    background: rgba(244, 67, 54, 0.3) !important;
    color: #F44336 !important;
    font-weight: bold;
}

.matrix-stats {
    background: rgba(0, 0, 0, 0.4);
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
}

.matrix-stats-content h4 {
    color: #ffd700;
    margin-bottom: 15px;
    text-align: center;
}

.matrix-stats-content p {
    color: #ccc;
    text-align: center;
    font-size: 16px;
    margin-bottom: 20px;
}

.matchup-section {
    margin-bottom: 20px;
}

.matchup-section h5 {
    margin-bottom: 10px;
}

.matchup-section ul {
    list-style: none;
    padding: 0;
}

.matchup-section li {
    padding: 5px 0;
    color: #ccc;
    border-bottom: 1px solid #333;
}

.matchup-section li:last-child {
    border-bottom: none;
}

.matrix-info {
    background: rgba(0, 0, 0, 0.4);
    border-radius: 10px;
    padding: 20px;
    margin-top: 30px;
}

.matrix-info ul {
    list-style: none;
    padding: 0;
}

.matrix-info li {
    padding: 8px 0;
    border-bottom: 1px solid #333;
}

.matrix-info li:last-child {
    border-bottom: none;
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
    .nav-menu {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .nav-btn {
        font-size: 12px;
        padding: 8px 16px;
    }
    
    .matrix-toggle {
        flex-direction: column;
        align-items: center;
    }
    
    .matrix-btn {
        width: 80%;
        max-width: 300px;
    }
    
    .matrix-table {
        font-size: 12px;
    }
    
    .matrix-table-content th,
    .matrix-table-content td {
        padding: 6px 4px;
        font-size: 11px;
    }
    
    .matrix-header {
        writing-mode: horizontal-tb;
        text-orientation: initial;
        min-width: 35px;
    }
}

/* å‹•ç•«æ•ˆæœ */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* åˆ†çµ„è®Šå‹•æ¨™è¨˜æŒ‰éˆ• */
.rank-change-btn {
    background: transparent;
    border: none;
    font-size: 16px;
    cursor: pointer;
    padding: 4px 8px;
    margin-left: 10px;
    border-radius: 4px;
    transition: all 0.3s ease;
    opacity: 0.6;
}

.rank-change-btn:hover {
    opacity: 1;
    background: rgba(255, 255, 255, 0.1);
    transform: scale(1.1);
}

.rank-change-btn.marked {
    opacity: 1;
    background: rgba(255, 193, 7, 0.2);
    border: 1px solid #FFC107;
}

/* å°æˆ°è¨˜éŒ„ç·¨è¼¯æŒ‰éˆ• */
.battle-actions {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-left: auto;
}

.edit-btn, .delete-btn {
    background: transparent;
    border: none;
    font-size: 14px;
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 4px;
    transition: all 0.3s ease;
    opacity: 0.6;
}

.edit-btn:hover {
    opacity: 1;
    background: rgba(33, 150, 243, 0.2);
    transform: scale(1.1);
}

.delete-btn:hover {
    opacity: 1;
    background: rgba(244, 67, 54, 0.2);
    transform: scale(1.1);
}

.battle-item {
    position: relative;
}

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸƒ é—‡å½±è©©ç« ï¼šå‡Œè¶Šä¸–ç•Œ (Shadowverse: Worlds Beyond)</h1>
            <p>å°æˆ°ç´€éŒ„è¿½è¹¤ç³»çµ±</p>
            
            <!-- å°èˆªé¸å–® -->
            <div class="nav-menu">
                <button class="nav-btn active" onclick="showPanel('stats')">ğŸ“Š å°æˆ°çµ±è¨ˆ</button>
                <button class="nav-btn" onclick="showPanel('matrix')">ğŸ¯ å°æˆ°çŸ©é™£</button>
                <button class="nav-btn" onclick="showPanel('player')">ğŸ‘¤ ç©å®¶è³‡æ–™</button>
                <button class="nav-btn" onclick="showPanel('battle')">âš”ï¸ å°æˆ°è¨˜éŒ„</button>
                <button class="nav-btn" onclick="showPanel('settings')">âš™ï¸ è¨­å®šåŒ¯å…¥</button>
            </div>
        </div>
        
        <!-- å°æˆ°çµ±è¨ˆé¢æ¿ -->
        <div id="statsPanel" class="panel active">
            <div class="stats-panel">
                <div class="stat-card">
                    <div class="stat-title">èµ·å§‹åˆ†çµ„</div>
                    <div class="stat-value" id="currentRank" style="cursor: pointer; transition: all 0.3s; font-size: 20px;" onclick="editCurrentRank()"></div>
                    <small style="color: #ccc; font-size: 12px;">é»æ“Šç·¨è¼¯</small>
                </div>
                <div class="stat-card">
                    <div class="stat-title">èµ·å§‹BP</div>
                    <div class="stat-value" id="startingBP" style="cursor: pointer; transition: all 0.3s;" onclick="editStartingBP()">43945</div>
                    <small style="color: #ccc; font-size: 12px;">é»æ“Šç·¨è¼¯</small>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ç›®å‰BP</div>
                    <div class="stat-value" id="currentBP">45427</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ç›®å‰éšç´š</div>
                    <div class="stat-value" id="currentRankLevel">A1</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ç¸½å°æˆ°å ´æ•¸</div>
                    <div class="stat-value" id="totalGames">10</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ç¸½å‹ç‡</div>
                    <div class="stat-value" id="winRate">60%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">å…ˆæ‰‹å‹ç‡</div>
                    <div class="stat-value" id="firstWinRate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">å¾Œæ‰‹å‹ç‡</div>
                    <div class="stat-value" id="secondWinRate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">é€£å‹/é€£æ•—</div>
                    <div class="stat-value" id="streak">1æ•—</div>
                </div>
            </div>
            
            <div class="rank-calculator">
                <h3 style="color: #ffd700; margin-bottom: 20px;">ğŸ† åˆ†çµ„å‡é™è¨ˆç®—å™¨</h3>
                <div class="rank-info">
                    <div class="rank-card" style="border-left: 8px solid #4caf50;">
                        <div class="rank-title">ğŸŸ¢ ç¶ å¯¶çŸ³åˆ†çµ„ <span style='color:#4caf50'>(x1.0)</span></div>
                        <div class="rank-requirement">â€¢ æ–°æ‰‹åˆ†çµ„<br>â€¢ å‡ç´šæ¢ä»¶ï¼šé”åˆ°ä¸€å®šBPè‡ªå‹•å‡ç´š<br>â€¢ å‹ç‡ç„¡å£“åŠ›ï¼Œå€ç‡x1.0</div>
                    </div>
                    <div class="rank-card" style="border-left: 8px solid #ffb300;">
                        <div class="rank-title">ğŸŸ  é»ƒå¯¶çŸ³åˆ†çµ„ <span style='color:#ffb300'>(x1.1)</span></div>
                        <div class="rank-requirement">â€¢ é€²éšåˆ†çµ„<br>â€¢ å‡ç´šæ¢ä»¶ï¼šBPé”æ¨™è‡ªå‹•å‡ç´š<br>â€¢ å‹ç‡å»ºè­°45%ä»¥ä¸Šï¼Œå€ç‡x1.1</div>
                    </div>
                    <div class="rank-card" style="border-left: 8px solid #e53935;">
                        <div class="rank-title">ğŸ”´ ç´…å¯¶çŸ³åˆ†çµ„ <span style='color:#e53935'>(x1.3)</span></div>
                        <div class="rank-requirement">â€¢ ä¸­é«˜ç´šåˆ†çµ„<br>â€¢ å‡ç´šæ¢ä»¶ï¼šBPé”æ¨™è‡ªå‹•å‡ç´š<br>â€¢ å‹ç‡å»ºè­°50%ä»¥ä¸Šï¼Œå€ç‡x1.3</div>
                    </div>
                    <div class="rank-card" style="border-left: 8px solid #1e88e5;">
                        <div class="rank-title">ğŸ”µ è—å¯¶çŸ³åˆ†çµ„ <span style='color:#1e88e5'>(x1.5)</span></div>
                        <div class="rank-requirement">â€¢ é«˜ç´šåˆ†çµ„<br>â€¢ å‡ç´šæ¢ä»¶ï¼šBPé”æ¨™è‡ªå‹•å‡ç´š<br>â€¢ å‹ç‡å»ºè­°55%ä»¥ä¸Šï¼Œå€ç‡x1.5</div>
                    </div>
                    <div class="rank-card" style="border-left: 8px solid #b39ddb;">
                        <div class="rank-title">ğŸ’ é‘½çŸ³åˆ†çµ„ <span style='color:#b39ddb'>(x2.0)</span></div>
                        <div class="rank-requirement">â€¢ æœ€é«˜åˆ†çµ„<br>â€¢ ç¶­æŒæ¢ä»¶ï¼šå‹ç‡60%ä»¥ä¸Š<br>â€¢ ä½æ–¼50%æœ‰æ‰ç´šé¢¨éšªï¼Œå€ç‡x2.0</div>
                    </div>
                </div>
                
                <div class="rank-status">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span><strong>ç›®å‰ç‹€æ…‹åˆ†æï¼š</strong></span>
                        <span id="rankStatusText" class="rank-safe">âœ… åˆ†çµ„å®‰å…¨</span>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="rankProgress" style="width: 60%"></div>
                    </div>
                    
                    <div id="rankAnalysis" style="color: #ccc; font-size: 14px; margin-top: 10px;">
                        æ ¹æ“šæ‚¨ç›®å‰60%çš„å‹ç‡ï¼Œåœ¨é‘½çŸ³åˆ†çµ„ä¸­è¡¨ç¾è‰¯å¥½ï¼Œå»ºè­°ç¹¼çºŒä¿æŒã€‚
                    </div>
                    
                    <div id="rankPrediction" style="color: #ffa726; font-size: 14px; margin-top: 10px;">
                        â€¢ å¦‚æœæ¥ä¸‹ä¾†5å ´å…¨æ•—ï¼Œå‹ç‡å°‡é™è‡³46%ï¼Œæœ‰æ‰ç´šé¢¨éšª<br>
                        â€¢ å¦‚æœæ¥ä¸‹ä¾†5å ´å…¨å‹ï¼Œå‹ç‡å°‡å‡è‡³71%ï¼Œåˆ†çµ„éå¸¸ç©©å®š
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å°æˆ°çŸ©é™£é¢æ¿ -->
        <div id="matrixPanel" class="panel">
            <div class="matrix-container">
                <h2 style="color: #ffd700; text-align: center; margin-bottom: 30px;">ğŸ¯ è·æ¥­å°æˆ°å‹ç‡çŸ©é™£</h2>
                
                <!-- çŸ©é™£åˆ‡æ›æŒ‰éˆ• -->
                <div class="matrix-toggle">
                    <button class="matrix-btn active" onclick="showMatrixType('first')" id="firstMatrixBtn">ğŸ”´ å…ˆæ‰‹å‹ç‡çŸ©é™£</button>
                    <button class="matrix-btn" onclick="showMatrixType('second')" id="secondMatrixBtn">ğŸ”µ å¾Œæ‰‹å‹ç‡çŸ©é™£</button>
                </div>
                
                <!-- å…ˆæ‰‹å‹ç‡çŸ©é™£ -->
                <div id="firstMatrix" class="matrix-table-container active">
                    <h3 style="color: #FF6B6B; text-align: center; margin-bottom: 20px;">ğŸ”´ å…ˆæ‰‹å‹ç‡çŸ©é™£</h3>
                    <div class="matrix-table" id="firstMatrixTable">
                        <!-- å…ˆæ‰‹çŸ©é™£è¡¨æ ¼å°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <div class="matrix-stats" id="firstMatrixStats">
                        <!-- å…ˆæ‰‹çµ±è¨ˆå°‡åœ¨æ­¤é¡¯ç¤º -->
                    </div>
                </div>
                
                <!-- å¾Œæ‰‹å‹ç‡çŸ©é™£ -->
                <div id="secondMatrix" class="matrix-table-container">
                    <h3 style="color: #4ECDC4; text-align: center; margin-bottom: 20px;">ğŸ”µ å¾Œæ‰‹å‹ç‡çŸ©é™£</h3>
                    <div class="matrix-table" id="secondMatrixTable">
                        <!-- å¾Œæ‰‹çŸ©é™£è¡¨æ ¼å°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <div class="matrix-stats" id="secondMatrixStats">
                        <!-- å¾Œæ‰‹çµ±è¨ˆå°‡åœ¨æ­¤é¡¯ç¤º -->
                    </div>
                </div>
                
                <!-- çŸ©é™£èªªæ˜ -->
                <div class="matrix-info">
                    <h4 style="color: #ffd700; margin-bottom: 15px;">ğŸ“‹ ä½¿ç”¨èªªæ˜</h4>
                    <ul style="color: #ccc; line-height: 1.6;">
                        <li><strong>ç¸±è»¸ï¼ˆå·¦å´ï¼‰</strong>ï¼šæ‚¨ä½¿ç”¨çš„è·æ¥­</li>
                        <li><strong>æ©«è»¸ï¼ˆä¸Šæ–¹ï¼‰</strong>ï¼šå°æ‰‹ä½¿ç”¨çš„è·æ¥­</li>
                        <li><strong>æ•¸å€¼</strong>ï¼šè©²çµ„åˆçš„å‹ç‡ç™¾åˆ†æ¯”</li>
                        <li><strong>é¡è‰²</strong>ï¼š
                            <span style="color: #4CAF50;">ç¶ è‰²</span> = é«˜å‹ç‡ (â‰¥70%), 
                            <span style="color: #FFC107;">é»ƒè‰²</span> = ä¸­ç­‰å‹ç‡ (50-69%), 
                            <span style="color: #F44336;">ç´…è‰²</span> = ä½å‹ç‡ (<50%)
                        </li>
                        <li><strong>--</strong>ï¼šè¡¨ç¤ºè©²çµ„åˆå°šç„¡å°æˆ°æ•¸æ“š</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- ç©å®¶è³‡æ–™é¢æ¿ -->
        <div id="playerPanel" class="panel">
            <div class="player-profile">
                <div class="profile-section">
                    <h3>ğŸ‘¤ åŸºæœ¬è³‡æ–™</h3>
                    <div class="profile-grid">
                        <div class="profile-item">
                            <div class="profile-label">ç©å®¶åç¨±</div>
                            <div class="profile-value editable" id="playerName" onclick="editPlayerName()">æœªè¨­å®š</div>
                        </div>
                        <div class="profile-item">
                            <div class="profile-label">éŠæˆ²ID</div>
                            <div class="profile-value editable" id="gameId" onclick="editGameId()">æœªè¨­å®š</div>
                        </div>
                        <div class="profile-item">
                            <div class="profile-label">è¨»å†Šæ—¥æœŸ</div>
                            <div class="profile-value" id="registerDate">2025-06-29</div>
                        </div>
                        <div class="profile-item">
                            <div class="profile-label">ä¸»è¦è·æ¥­</div>
                            <div class="profile-value editable" id="mainClass" onclick="editMainClass()">é¾</div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-section">
                    <h3>ğŸ¯ éŠæˆ²ç›®æ¨™</h3>
                    <div class="profile-grid">
                        <div class="profile-item">
                            <div class="profile-label">ç›®æ¨™åˆ†çµ„</div>
                            <div class="profile-value editable" id="targetRank" onclick="editTargetRank()">é‘½çŸ³</div>
                        </div>
                        <div class="profile-item">
                            <div class="profile-label">ç›®æ¨™å‹ç‡</div>
                            <div class="profile-value" id="targetWinRate">70%</div>
                        </div>
                        <div class="profile-item">
                            <div class="profile-label">æœˆç›®æ¨™å ´æ•¸</div>
                            <div class="profile-value" id="monthlyTarget">100å ´</div>
                        </div>
                        <div class="profile-item">
                            <div class="profile-label">ç›®æ¨™BP</div>
                            <div class="profile-value" id="targetBP">60000</div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-section">
                    <h3>ğŸ“Š æ­·å²ç´€éŒ„</h3>
                    <div class="profile-grid">
                        <div class="profile-item">
                            <div class="profile-label">æœ€é«˜åˆ†çµ„</div>
                            <div class="profile-value" id="highestRank">é‘½çŸ³</div>
                        </div>
                        <div class="profile-item">
                            <div class="profile-label">æœ€é«˜BP</div>
                            <div class="profile-value" id="highestBP">52000</div>
                        </div>
                        <div class="profile-item">
                            <div class="profile-label">æœ€é•·é€£å‹</div>
                            <div class="profile-value" id="longestWinStreak">8å ´</div>
                        </div>
                        <div class="profile-item">
                            <div class="profile-label">ç¸½éŠæˆ²æ™‚é–“</div>
                            <div class="profile-value" id="totalPlayTime">45å°æ™‚</div>
                        </div>
                    </div>
                </div>
                
                <!-- ä¿å­˜æ“ä½œå€åŸŸ -->
                <div class="profile-section">
                    <h3>ğŸ’¾ è³‡æ–™ç®¡ç†</h3>
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button class="btn" onclick="savePlayerProfile()" style="background: #4caf50;">
                            ğŸ’¾ ä¿å­˜è³‡æ–™
                        </button>
                        <button class="btn" onclick="resetPlayerProfile()" style="background: #ff9800;">
                            ğŸ”„ é‡ç½®è³‡æ–™
                        </button>
                        <button class="btn" onclick="exportPlayerProfile()" style="background: #2196f3;">
                            ğŸ“¤ åŒ¯å‡ºè³‡æ–™
                        </button>
                        <button class="btn" onclick="exportRankChangeAnalysis()" style="background: #9c27b0;">
                            ğŸ“Š åŒ¯å‡ºåˆ†çµ„è®Šå‹•åˆ†æ
                        </button>
                    </div>
                    <div id="saveStatus" style="margin-top: 10px; color: #4caf50; font-size: 14px; display: none;">
                        âœ… è³‡æ–™å·²ä¿å­˜
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å°æˆ°è¨˜éŒ„é¢æ¿ -->
        <div id="battlePanel" class="panel">
            <div class="battle-form">
                <h3 style="color: #ffd700; margin-bottom: 20px;">âš”ï¸ æ–°å¢å°æˆ°è¨˜éŒ„</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="myClass">æˆ‘çš„è·æ¥­</label>
                        <select id="myClass">
                            <option value="çš‡å®¶">çš‡å®¶</option>
                            <option value="ç²¾éˆ">ç²¾éˆ</option>
                            <option value="å·«å¸«">å·«å¸«</option>
                            <option value="é¾" selected>é¾</option>
                            <option value="å¤œé­”">å¤œé­”</option>
                            <option value="ä¸»æ•™">ä¸»æ•™</option>
                            <option value="å¾©ä»‡è€…">å¾©ä»‡è€…</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="opponentClass">å°æ‰‹è·æ¥­</label>
                        <select id="opponentClass">
                            <option value="çš‡å®¶">çš‡å®¶</option>
                            <option value="ç²¾éˆ">ç²¾éˆ</option>
                            <option value="å·«å¸«">å·«å¸«</option>
                            <option value="é¾">é¾</option>
                            <option value="å¤œé­”">å¤œé­”</option>
                            <option value="ä¸»æ•™">ä¸»æ•™</option>
                            <option value="å¾©ä»‡è€…">å¾©ä»‡è€…</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="turnOrder">å…ˆå¾Œæ‰‹</label>
                        <select id="turnOrder">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="å…ˆæ‰‹">å…ˆæ‰‹</option>
                            <option value="å¾Œæ‰‹">å¾Œæ‰‹</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="result">å°æˆ°çµæœ</label>
                        <select id="result">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="å‹">å‹åˆ©</option>
                            <option value="æ•—">æ•—åŒ—</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="bpChange">BPè®ŠåŒ– <span style="color: #4CAF50; font-size: 12px;">ğŸ’¡ è¼¸å…¥å®Œæˆå¾ŒæŒ‰ Enter éµæäº¤</span></label>
                        <input type="number" id="bpChange" placeholder="å»ºè­°å€¼: +320" min="0" title="è¼¸å…¥BPè®ŠåŒ–å€¼ï¼ŒæŒ‰Enteréµæäº¤å°æˆ°è¨˜éŒ„">
                    </div>
                </div>
                
                <!-- ç§»é™¤æŒ‰éˆ•ï¼Œæ”¹ç”¨ Enter éµæäº¤ -->
                <div style="text-align: center; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; margin: 10px 0;">
                    <span style="color: #4CAF50; font-size: 14px;">âŒ¨ï¸ å¡«å¯«å®Œæ‰€æœ‰æ¬„ä½å¾Œï¼Œåœ¨ BP è¼¸å…¥æ¡†æŒ‰ <kbd style="background: #333; color: #fff; padding: 3px 6px; border-radius: 3px;">Enter</kbd> éµå³å¯æ–°å¢å°æˆ°è¨˜éŒ„</span>
                </div>
            </div>
            
            <div class="battle-history">
                <h3 style="color: #ffd700; padding: 20px; margin: 0;">ğŸ“‹ å°æˆ°æ­·å²</h3>
                <div id="battleList"></div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn export-btn" onclick="exportData()">ğŸ“¥ åŒ¯å‡ºæ•¸æ“š</button>
                <button class="btn clear-btn" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ•¸æ“š</button>
            </div>
        </div>
        
        <!-- è¨­å®šåŒ¯å…¥é¢æ¿ -->
        <div id="settingsPanel" class="panel">
            <div class="import-area" id="importArea" onclick="document.getElementById('fileInput').click();">
                <p>ğŸ“ é»æ“Šæ­¤è™•é¸æ“‡æª”æ¡ˆæˆ–æ‹–æ”¾æ–‡å­—æª”æ¡ˆé€²è¡ŒåŒ¯å…¥</p>
                <p style="color: #ccc; font-size: 14px;">æ”¯æ´æ ¼å¼ï¼š.txt æ–‡å­—æª”æ¡ˆ</p>
                <input type="file" id="fileInput" class="file-input" accept=".txt" onchange="importFromFile(event)">
            </div>
            
            <!-- æ”¯æŒé–‹ç™¼è€…å€æ®µ -->
            <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, rgba(103, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 15px; border: 2px solid rgba(255, 215, 0, 0.3);">
                <h3 style="color: #ffd700; margin: 0 0 20px 0; text-align: center;">ğŸ’ æ”¯æŒé–‹ç™¼è€…</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <h4 style="color: #64b5f6; margin: 0 0 10px 0;">ğŸ ææ¬¾æ”¯æŒ</h4>
                        <p style="margin: 5px 0; font-size: 14px;">è¡—å£æ”¯ä»˜: <strong>901539824</strong> (Jno)</p>
                        <p style="margin: 5px 0; font-size: 14px;">
                            <a href="https://paypal.me/xiujiang1987?country.x=TW&locale.x=zh_TW" target="_blank" style="color: #64b5f6; text-decoration: none;">
                                ğŸ’³ PayPal æ”¯æŒ
                            </a>
                        </p>
                    </div>
                    
                    <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <h4 style="color: #64b5f6; margin: 0 0 10px 0;">â­ å…¶ä»–æ”¯æŒ</h4>
                        <p style="margin: 5px 0; font-size: 14px;">
                            <a href="https://github.com/xiujiang1987/shadowverse-worlds-beyond-tracker" target="_blank" style="color: #64b5f6; text-decoration: none;">
                                ğŸŒŸ GitHub Star
                            </a>
                        </p>
                        <p style="margin: 5px 0; font-size: 14px;">
                            <a href="https://github.com/xiujiang1987/shadowverse-worlds-beyond-tracker/issues" target="_blank" style="color: #64b5f6; text-decoration: none;">
                                ğŸ› å›å ±å•é¡Œ
                            </a>
                        </p>
                        <p style="margin: 5px 0; font-size: 14px;">ğŸ“¢ æ¨è–¦çµ¦æœ‹å‹</p>
                    </div>
                </div>
                
                <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 10px;">
                    <p style="margin: 0; font-size: 13px; color: #ccc;">
                        ğŸ’• æ„Ÿè¬æ‚¨çš„æ”¯æŒï¼æ¯ä¸€ä»½ææ¬¾å’Œå›é¥‹éƒ½æ˜¯æŒçºŒé–‹ç™¼çš„å‹•åŠ›
                    </p>
                    <p style="margin: 8px 0 0 0; font-size: 12px; color: #999;">
                        ğŸ™ è®“æˆ‘å€‘ä¸€èµ·ç‚º Shadowverse ç¤¾ç¾¤æä¾›æ›´å¥½çš„å·¥å…·
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>

        // === src/js/config.js ===
        // Shadowverse: Worlds Beyond Tracker - é…ç½®èˆ‡å¸¸æ•¸
// æ­¤æ–‡ä»¶åŒ…å«æ‰€æœ‰æ‡‰ç”¨ç¨‹å¼çš„é…ç½®å¸¸æ•¸å’ŒåŸºç¤æ•¸æ“š

const CONFIG = {
    // ç‰ˆæœ¬è³‡è¨Š
    VERSION: 'v1.5.6',
    BUILD_DATE: '2025-01-22',
    
    // localStorage keys
    STORAGE_KEYS: {
        PLAYER: 'shadowverseWorldsBeyondPlayer',
        BATTLES: 'shadowverseWorldsBeyondBattles',
        STARTING_BP: 'shadowverseWorldsBeyondStartingBP',
        CURRENT_GROUP: 'shadowverseWorldsBeyondCurrentGroup', // åˆ†çµ„(Group): ç¶ å¯¶çŸ³ã€é»ƒå¯¶çŸ³ç­‰
        RANK_CHANGES: 'shadowverseWorldsBeyondRankChanges'
    },
    
    // é»˜èªå€¼
    DEFAULTS: {
        STARTING_BP: 43945,
        CURRENT_GROUP: 'é‘½çŸ³', // åˆ†çµ„ï¼Œééšç´š
        WIN_BP: 320,
        LOSE_BP: 30
    },
    
    // éŠæˆ²è¦å‰‡
    GAME_RULES: {
        MIN_GAMES_FOR_RANK_ADJUSTMENT: 15,
        MIN_GAMES_FOR_RANK_DANGER: 20
    }
};

// åˆ†çµ„æ•¸æ“šï¼ˆGroup Dataï¼‰- éŠæˆ²å…§çš„å¯¶çŸ³ç³»çµ±
const GROUP_DATA = {
    'ç¶ å¯¶çŸ³': {
        icon: 'ğŸŸ¢',
        name: 'ç¶ å¯¶çŸ³',
        maintain: 40,
        danger: 30,
        multiplier: 'x1.0',
        color: '#4caf50',
        description: 'â€¢ æ–°æ‰‹åˆ†çµ„<br>â€¢ å‡ç´šæ¢ä»¶ï¼šé”åˆ°ä¸€å®šBPè‡ªå‹•å‡ç´š<br>â€¢ å‹ç‡ç„¡å£“åŠ›ï¼Œå€ç‡x1.0'
    },
    'é»ƒå¯¶çŸ³': {
        icon: 'ğŸŸ ',
        name: 'é»ƒå¯¶çŸ³',
        maintain: 45,
        danger: 35,
        multiplier: 'x1.1',
        color: '#ffb300',
        description: 'â€¢ é€²éšåˆ†çµ„<br>â€¢ å‡ç´šæ¢ä»¶ï¼šBPé”æ¨™è‡ªå‹•å‡ç´š<br>â€¢ å‹ç‡å»ºè­°45%ä»¥ä¸Šï¼Œå€ç‡x1.1'
    },
    'ç´…å¯¶çŸ³': {
        icon: 'ğŸ”´',
        name: 'ç´…å¯¶çŸ³',
        maintain: 50,
        danger: 40,
        multiplier: 'x1.3',
        color: '#e53935',
        description: 'â€¢ ä¸­é«˜ç´šåˆ†çµ„<br>â€¢ å‡ç´šæ¢ä»¶ï¼šBPé”æ¨™è‡ªå‹•å‡ç´š<br>â€¢ å‹ç‡å»ºè­°50%ä»¥ä¸Šï¼Œå€ç‡x1.3'
    },
    'è—å¯¶çŸ³': {
        icon: 'ğŸ”µ',
        name: 'è—å¯¶çŸ³',
        maintain: 55,
        danger: 45,
        multiplier: 'x1.5',
        color: '#1e88e5',
        description: 'â€¢ é«˜ç´šåˆ†çµ„<br>â€¢ å‡ç´šæ¢ä»¶ï¼šBPé”æ¨™è‡ªå‹•å‡ç´š<br>â€¢ å‹ç‡å»ºè­°55%ä»¥ä¸Šï¼Œå€ç‡x1.5'
    },
    'é‘½çŸ³': {
        icon: 'ğŸ’',
        name: 'é‘½çŸ³',
        maintain: 60,
        danger: 50,
        multiplier: 'x2.0',
        color: '#b39ddb',
        description: 'â€¢ æœ€é«˜åˆ†çµ„<br>â€¢ ç¶­æŒæ¢ä»¶ï¼šå‹ç‡60%ä»¥ä¸Š<br>â€¢ ä½æ–¼50%æœ‰æ‰ç´šé¢¨éšªï¼Œå€ç‡x2.0'
    }
};

// ç‚ºäº†å‘å¾Œç›¸å®¹ï¼Œä¿ç•™èˆŠåç¨±
const RANK_DATA = GROUP_DATA;

// è·æ¥­æ•¸æ“š
const CLASS_DATA = {
    'çš‡å®¶': { color: '#FFD700', textColor: '#000' },
    'ç²¾éˆ': { color: '#228B22', textColor: '#fff' },
    'å·«å¸«': { color: '#4169E1', textColor: '#fff' },
    'é¾': { color: '#DC143C', textColor: '#fff' },
    'å¤œé­”': { color: 'linear-gradient(45deg, #8B008B, #8B0000)', textColor: '#fff' },
    'ä¸»æ•™': { color: '#F0E68C', textColor: '#000' },
    'å¾©ä»‡è€…': { color: '#2F4F4F', textColor: '#fff' }
};

// è·æ¥­åˆ—è¡¨ï¼ˆç”¨æ–¼å°æˆ°çŸ©é™£ï¼‰
const CLASS_LIST = ['çš‡å®¶', 'ç²¾éˆ', 'å·«å¸«', 'é¾', 'å¤œé­”', 'ä¸»æ•™', 'å¾©ä»‡è€…'];

// é»˜èªç©å®¶æ•¸æ“š
const DEFAULT_PLAYER_DATA = {
    name: 'æœªè¨­å®š',
    gameId: 'æœªè¨­å®š',
    registerDate: '2025-06-29',
    mainClass: 'é¾',
    targetRank: 'é‘½çŸ³',
    targetWinRate: '70%',
    monthlyTarget: '100å ´',
    targetBP: '60000',
    highestRank: 'é‘½çŸ³',
    highestBP: '52000',
    longestWinStreak: '8å ´',
    totalPlayTime: '45å°æ™‚'
};

// é»˜èªå°æˆ°æ•¸æ“š
const DEFAULT_BATTLE_DATA = [
    {id: 1, myClass: 'é¾', opponentClass: 'çš‡å®¶', result: 'å‹', bpChange: 320, timestamp: '2025-06-26', turnOrder: 'å…ˆæ‰‹'},
    {id: 2, myClass: 'é¾', opponentClass: 'çš‡å®¶', result: 'å‹', bpChange: 320, timestamp: '2025-06-26', turnOrder: 'å¾Œæ‰‹'},
    {id: 3, myClass: 'é¾', opponentClass: 'ç²¾éˆ', result: 'å‹', bpChange: 380, timestamp: '2025-06-26', turnOrder: 'å…ˆæ‰‹'},
    {id: 4, myClass: 'é¾', opponentClass: 'çš‡å®¶', result: 'å‹', bpChange: 380, timestamp: '2025-06-26', turnOrder: 'å¾Œæ‰‹'},
    {id: 5, myClass: 'é¾', opponentClass: 'ç²¾éˆ', result: 'æ•—', bpChange: 30, timestamp: '2025-06-26', turnOrder: 'å…ˆæ‰‹'},
    {id: 6, myClass: 'é¾', opponentClass: 'å·«å¸«', result: 'æ•—', bpChange: 22, timestamp: '2025-06-26', turnOrder: 'å¾Œæ‰‹'},
    {id: 7, myClass: 'é¾', opponentClass: 'å¾©ä»‡è€…', result: 'æ•—', bpChange: 30, timestamp: '2025-06-26', turnOrder: 'å…ˆæ‰‹'},
    {id: 8, myClass: 'é¾', opponentClass: 'å·«å¸«', result: 'å‹', bpChange: 260, timestamp: '2025-06-28', turnOrder: 'å¾Œæ‰‹'},
    {id: 9, myClass: 'é¾', opponentClass: 'å·«å¸«', result: 'å‹', bpChange: 320, timestamp: '2025-06-28', turnOrder: 'å…ˆæ‰‹'},
    {id: 10, myClass: 'é¾', opponentClass: 'å·«å¸«', result: 'æ•—', bpChange: 28, timestamp: '2025-06-28', turnOrder: 'å¾Œæ‰‹'},
    {id: 11, myClass: 'é¾', opponentClass: 'é¾', result: 'å‹', bpChange: 320, timestamp: '2025-06-28', turnOrder: 'å…ˆæ‰‹'},
    {id: 12, myClass: 'é¾', opponentClass: 'å·«å¸«', result: 'æ•—', bpChange: 24, timestamp: '2025-06-28', turnOrder: 'å¾Œæ‰‹'},
    {id: 13, myClass: 'çš‡å®¶', opponentClass: 'ç²¾éˆ', result: 'å‹', bpChange: 320, timestamp: '2025-06-29', turnOrder: 'å…ˆæ‰‹'},
    {id: 14, myClass: 'çš‡å®¶', opponentClass: 'å¤œé­”', result: 'æ•—', bpChange: 30, timestamp: '2025-06-29', turnOrder: 'å¾Œæ‰‹'},
    {id: 15, myClass: 'ç²¾éˆ', opponentClass: 'ä¸»æ•™', result: 'å‹', bpChange: 320, timestamp: '2025-06-29', turnOrder: 'å…ˆæ‰‹'},
    {id: 16, myClass: 'ç²¾éˆ', opponentClass: 'å¾©ä»‡è€…', result: 'å‹', bpChange: 380, timestamp: '2025-06-29', turnOrder: 'å¾Œæ‰‹'},
    {id: 17, myClass: 'å·«å¸«', opponentClass: 'çš‡å®¶', result: 'æ•—', bpChange: 25, timestamp: '2025-06-29', turnOrder: 'å…ˆæ‰‹'},
    {id: 18, myClass: 'å¤œé­”', opponentClass: 'é¾', result: 'å‹', bpChange: 340, timestamp: '2025-06-29', turnOrder: 'å¾Œæ‰‹'}
];

// å°å‡ºé…ç½®ï¼ˆES6æ¨¡çµ„èªæ³•å‚™ç”¨ï¼‰
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        CONFIG,
        RANK_DATA,
        CLASS_DATA,
        DEFAULT_PLAYER_DATA,
        DEFAULT_BATTLE_DATA
    };
}


        // === src/js/data-manager.js ===
        // Shadowverse: Worlds Beyond Tracker - æ•¸æ“šç®¡ç†æ¨¡çµ„
// è² è²¬æ‰€æœ‰localStorageæ“ä½œå’Œæ•¸æ“šç®¡ç†

class DataManager {
    constructor() {
        this.playerData = this.loadPlayerData();
        this.battleData = this.loadBattleData();
        this.startingBP = this.loadStartingBP();
        this.currentGroup = this.loadCurrentGroup();
        this.rankChangeHistory = this.loadRankChangeHistory(); // æ–°å¢åˆ†çµ„è®Šå‹•æ­·å²
    }

    // è¼‰å…¥ç©å®¶è³‡æ–™
    loadPlayerData() {
        const stored = localStorage.getItem(CONFIG.STORAGE_KEYS.PLAYER);
        return stored ? JSON.parse(stored) : { ...DEFAULT_PLAYER_DATA };
    }

    // å„²å­˜ç©å®¶è³‡æ–™
    savePlayerData(data = null) {
        if (data) this.playerData = data;
        localStorage.setItem(CONFIG.STORAGE_KEYS.PLAYER, JSON.stringify(this.playerData));
    }

    // è¼‰å…¥å°æˆ°æ•¸æ“š
    loadBattleData() {
        const stored = localStorage.getItem(CONFIG.STORAGE_KEYS.BATTLES);
        return stored ? JSON.parse(stored) : [...DEFAULT_BATTLE_DATA];
    }

    // å„²å­˜å°æˆ°æ•¸æ“š
    saveBattleData(data = null) {
        if (data) this.battleData = data;
        localStorage.setItem(CONFIG.STORAGE_KEYS.BATTLES, JSON.stringify(this.battleData));
    }

    // è¼‰å…¥èµ·å§‹BP
    loadStartingBP() {
        const stored = localStorage.getItem(CONFIG.STORAGE_KEYS.STARTING_BP);
        return stored ? parseInt(stored) : CONFIG.DEFAULTS.STARTING_BP;
    }

    // å„²å­˜èµ·å§‹BP
    saveStartingBP(bp = null) {
        if (bp !== null) this.startingBP = bp;
        localStorage.setItem(CONFIG.STORAGE_KEYS.STARTING_BP, this.startingBP);
    }

    // è¼‰å…¥ç•¶å‰åˆ†çµ„
    loadCurrentGroup() {
        const stored = localStorage.getItem(CONFIG.STORAGE_KEYS.CURRENT_GROUP);
        return stored || CONFIG.DEFAULTS.CURRENT_GROUP;
    }

    // å„²å­˜ç•¶å‰åˆ†çµ„
    saveCurrentGroup(group = null) {
        if (group) this.currentGroup = group;
        localStorage.setItem(CONFIG.STORAGE_KEYS.CURRENT_GROUP, this.currentGroup);
    }

    // è¼‰å…¥åˆ†çµ„è®Šå‹•æ­·å²
    loadRankChangeHistory() {
        const stored = localStorage.getItem(CONFIG.STORAGE_KEYS.RANK_CHANGES);
        return stored ? JSON.parse(stored) : [];
    }

    // å„²å­˜åˆ†çµ„è®Šå‹•æ­·å²
    saveRankChangeHistory(data = null) {
        if (data) this.rankChangeHistory = data;
        localStorage.setItem(CONFIG.STORAGE_KEYS.RANK_CHANGES, JSON.stringify(this.rankChangeHistory));
    }

    // æ–°å¢å°æˆ°è¨˜éŒ„
    addBattle(battleData) {
        const newBattle = {
            id: this.battleData.length + 1,
            ...battleData,
            timestamp: new Date().toISOString().split('T')[0]
        };
        this.battleData.push(newBattle);
        this.saveBattleData();
        return newBattle;
    }

    // ç·¨è¼¯å°æˆ°è¨˜éŒ„
    editBattle(battleId, updatedData) {
        const battleIndex = this.battleData.findIndex(battle => battle.id === battleId);
        if (battleIndex === -1) return false;

        // ä¿ç•™åŸæœ‰çš„idå’Œtimestamp
        const originalBattle = this.battleData[battleIndex];
        this.battleData[battleIndex] = {
            ...originalBattle,
            ...updatedData,
            id: originalBattle.id,
            timestamp: originalBattle.timestamp
        };

        this.saveBattleData();
        return true;
    }

    // åˆªé™¤å°æˆ°è¨˜éŒ„
    deleteBattle(battleId) {
        const battleIndex = this.battleData.findIndex(battle => battle.id === battleId);
        if (battleIndex === -1) return false;

        this.battleData.splice(battleIndex, 1);
        
        // é‡æ–°ç·¨è™ŸID
        this.battleData.forEach((battle, index) => {
            battle.id = index + 1;
        });

        this.saveBattleData();
        
        // åŒæ™‚æ¸…ç†ç›¸é—œçš„åˆ†çµ„è®Šå‹•è¨˜éŒ„
        this.rankChangeHistory = this.rankChangeHistory.filter(change => change.battleId !== battleId);
        this.saveRankChangeHistory();
        
        return true;
    }

    // å–å¾—å–®ä¸€å°æˆ°è¨˜éŒ„
    getBattle(battleId) {
        return this.battleData.find(battle => battle.id === battleId);
    }

    // æ¸…é™¤æ‰€æœ‰å°æˆ°æ•¸æ“š
    clearAllBattles() {
        this.battleData = [];
        localStorage.removeItem(CONFIG.STORAGE_KEYS.BATTLES);
    }

    // è¨˜éŒ„åˆ†çµ„è®Šå‹•
    recordRankChange(battleIndex, fromRank, toRank, winRate, totalGames, reason = 'æ‰‹å‹•æ¨™è¨˜') {
        const battle = this.battleData[battleIndex];
        if (!battle) return false;

        const changeRecord = {
            id: this.rankChangeHistory.length + 1,
            battleId: battle.id,
            battleIndex: battleIndex + 1, // é¡¯ç¤ºç”¨ï¼ˆå¾1é–‹å§‹ï¼‰
            timestamp: new Date().toISOString(),
            fromRank,
            toRank,
            battleDetails: {
                myClass: battle.myClass,
                opponentClass: battle.opponentClass,
                result: battle.result,
                turnOrder: battle.turnOrder,
                bpChange: battle.bpChange
            },
            statsAtChange: {
                winRate,
                totalGames,
                currentBP: this.startingBP + this.battleData.slice(0, battleIndex + 1).reduce((sum, b) => sum + b.bpChange, 0)
            },
            reason
        };

        this.rankChangeHistory.push(changeRecord);
        this.saveRankChangeHistory();
        return changeRecord;
    }

    // åˆªé™¤åˆ†çµ„è®Šå‹•è¨˜éŒ„
    removeRankChange(changeId) {
        this.rankChangeHistory = this.rankChangeHistory.filter(change => change.id !== changeId);
        this.saveRankChangeHistory();
    }

    // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
    getStatistics() {
        const totalGames = this.battleData.length;
        const wins = this.battleData.filter(b => b.result === 'å‹').length;
        const winRate = totalGames > 0 ? Math.round((wins / totalGames) * 100) : 0;
        const currentBP = this.startingBP + this.battleData.reduce((sum, b) => sum + b.bpChange, 0);

        // è¨ˆç®—å…ˆæ‰‹å¾Œæ‰‹çµ±è¨ˆ
        const firstTurnGames = this.battleData.filter(b => b.turnOrder === 'å…ˆæ‰‹');
        const secondTurnGames = this.battleData.filter(b => b.turnOrder === 'å¾Œæ‰‹');
        
        const firstTurnWins = firstTurnGames.filter(b => b.result === 'å‹').length;
        const secondTurnWins = secondTurnGames.filter(b => b.result === 'å‹').length;
        
        const firstWinRate = firstTurnGames.length > 0 ? Math.round((firstTurnWins / firstTurnGames.length) * 100) : 0;
        const secondWinRate = secondTurnGames.length > 0 ? Math.round((secondTurnWins / secondTurnGames.length) * 100) : 0;

        // è¨ˆç®—é€£å‹/é€£æ•—
        let streak = 0;
        let streakType = '';
        if (totalGames > 0) {
            streakType = this.battleData[totalGames - 1].result;
            for (let i = totalGames - 1; i >= 0; i--) {
                if (this.battleData[i].result === streakType) {
                    streak++;
                } else {
                    break;
                }
            }
        }

        return {
            totalGames,
            wins,
            winRate,
            currentBP,
            streak,
            streakType,
            firstTurnGames: firstTurnGames.length,
            secondTurnGames: secondTurnGames.length,
            firstTurnWins,
            secondTurnWins,
            firstWinRate,
            secondWinRate,
            lastMatchResult: totalGames > 0 ? this.battleData[totalGames - 1].result : null
        };
    }

    // å–å¾—è·æ¥­å°æˆ°çŸ©é™£çµ±è¨ˆ
    getMatrixStatistics() {
        const matrix = {
            first: {}, // å…ˆæ‰‹æ•¸æ“š
            second: {} // å¾Œæ‰‹æ•¸æ“š
        };

        // åˆå§‹åŒ–çŸ©é™£
        CLASS_LIST.forEach(myClass => {
            matrix.first[myClass] = {};
            matrix.second[myClass] = {};
            CLASS_LIST.forEach(opponentClass => {
                matrix.first[myClass][opponentClass] = { wins: 0, total: 0, winRate: 0 };
                matrix.second[myClass][opponentClass] = { wins: 0, total: 0, winRate: 0 };
            });
        });

        // çµ±è¨ˆå°æˆ°æ•¸æ“š
        this.battleData.forEach(battle => {
            const { myClass, opponentClass, result, turnOrder } = battle;
            
            // åªè™•ç†æœ‰å…ˆæ‰‹/å¾Œæ‰‹ä¿¡æ¯çš„å°æˆ°
            if (!turnOrder || !CLASS_LIST.includes(myClass) || !CLASS_LIST.includes(opponentClass)) {
                return;
            }

            const turnMatrix = turnOrder === 'å…ˆæ‰‹' ? matrix.first : matrix.second;
            
            if (turnMatrix[myClass] && turnMatrix[myClass][opponentClass]) {
                turnMatrix[myClass][opponentClass].total++;
                if (result === 'å‹') {
                    turnMatrix[myClass][opponentClass].wins++;
                }
                
                // è¨ˆç®—å‹ç‡
                const total = turnMatrix[myClass][opponentClass].total;
                const wins = turnMatrix[myClass][opponentClass].wins;
                turnMatrix[myClass][opponentClass].winRate = total > 0 ? Math.round((wins / total) * 100) : 0;
            }
        });

        return matrix;
    }

    // å°å‡ºæ•¸æ“š
    exportData() {
        const stats = this.getStatistics();
        const currentRankLevel = RankManager.calculateRank(stats.currentBP);
        
        let exportText = `é—‡å½±è©©ç« :å‡Œè¶Šä¸–ç•Œ å°æˆ°ç´€éŒ„\n`;
        exportText += `æ—¥æœŸï¼š${new Date().toISOString().split('T')[0]}\n`;
        exportText += `éšç´šï¼š${currentRankLevel}\n`;
        exportText += `èµ·å§‹BPï¼š${this.startingBP}\n`;
        exportText += `ç›®å‰BPï¼š${stats.currentBP}\n`;
        exportText += `åˆ†çµ„ï¼š${RANK_DATA[this.currentGroup].name}\n`;
        exportText += `ç¸½å‹ç‡ï¼š${stats.winRate}% (${stats.wins}å‹/${stats.totalGames - stats.wins}æ•—)\n`;
        exportText += `å…ˆæ‰‹å‹ç‡ï¼š${stats.firstWinRate}% (${stats.firstTurnWins}å‹/${stats.firstTurnGames - stats.firstTurnWins}æ•—ï¼Œå…±${stats.firstTurnGames}å ´)\n`;
        exportText += `å¾Œæ‰‹å‹ç‡ï¼š${stats.secondWinRate}% (${stats.secondTurnWins}å‹/${stats.secondTurnGames - stats.secondTurnWins}æ•—ï¼Œå…±${stats.secondTurnGames}å ´)\n\n`;
        
        this.battleData.forEach((battle, index) => {
            const turnInfo = battle.turnOrder ? ` ${battle.turnOrder}` : '';
            exportText += `ç¬¬${index + 1}å ´ï¼š${battle.myClass}å°æˆ°${battle.opponentClass}${turnInfo} ${battle.result}ï¼ˆ${battle.bpChange > 0 ? '+' : ''}${battle.bpChange}BPï¼‰\n`;
        });
        
        return exportText;
    }

    // è§£æå°å…¥æ•¸æ“š
    parseImportData(content) {
        try {
            const lines = content.split('\n').map(line => line.trim()).filter(line => line);
            let newStartingBP = this.startingBP;
            let newCurrentBP = null;
            let detectedGroup = null; // åˆ†çµ„ï¼Œä¸æ˜¯éšç´š
            const newBattleData = [];
            
            for (const line of lines) {
                // è§£æèµ·å§‹BP
                if (line.includes('èµ·å§‹BPï¼š')) {
                    const bpMatch = line.match(/èµ·å§‹BPï¼š(\d+)/);
                    if (bpMatch) {
                        newStartingBP = parseInt(bpMatch[1]);
                    }
                }
                
                // è§£æç›®å‰BP
                if (line.includes('ç›®å‰BPï¼š')) {
                    const bpMatch = line.match(/ç›®å‰BPï¼š(\d+)/);
                    if (bpMatch) {
                        newCurrentBP = parseInt(bpMatch[1]);
                    }
                }
                
                // è§£æåˆ†çµ„ï¼ˆä¸æ˜¯éšç´šï¼‰
                if (line.includes('åˆ†çµ„ï¼š')) {
                    const groupMatch = line.match(/åˆ†çµ„ï¼š(.+)/);
                    if (groupMatch) {
                        detectedGroup = groupMatch[1].trim();
                    }
                }
                
                // è§£æå°æˆ°è¨˜éŒ„ï¼ˆåŒ…å«å…ˆæ‰‹/å¾Œæ‰‹ä¿¡æ¯ï¼‰
                const battleMatchWithTurn = line.match(/ç¬¬(\d+)å ´ï¼š(.+)å°æˆ°(.+)\s+(å…ˆæ‰‹|å¾Œæ‰‹)\s+(å‹|æ•—)ï¼ˆ\+(\d+)BPï¼‰/);
                const battleMatchSimple = line.match(/ç¬¬(\d+)å ´ï¼š(.+)å°æˆ°(.+)\s+(å‹|æ•—)ï¼ˆ\+(\d+)BPï¼‰/);
                
                if (battleMatchWithTurn) {
                    const [, id, myClass, opponentClass, turnOrder, result, bpChange] = battleMatchWithTurn;
                    newBattleData.push({
                        id: parseInt(id),
                        myClass: this.convertOldClassName(myClass),
                        opponentClass: this.convertOldClassName(opponentClass),
                        result,
                        bpChange: parseInt(bpChange),
                        turnOrder,
                        timestamp: new Date().toISOString().split('T')[0]
                    });
                } else if (battleMatchSimple) {
                    const [, id, myClass, opponentClass, result, bpChange] = battleMatchSimple;
                    newBattleData.push({
                        id: parseInt(id),
                        myClass: this.convertOldClassName(myClass),
                        opponentClass: this.convertOldClassName(opponentClass),
                        result,
                        bpChange: parseInt(bpChange),
                        timestamp: new Date().toISOString().split('T')[0]
                    });
                }
            }
            
            if (newBattleData.length > 0) {
                // è¨ˆç®—é æœŸçš„ç›®å‰BPä»¥é©—è­‰æ•¸æ“š
                let calculatedBP = newStartingBP;
                newBattleData.forEach(battle => {
                    calculatedBP += battle.bpChange;
                });
                
                // è¨ˆç®—å°å…¥å¾Œçš„å‹ç‡ä»¥é©—è­‰åˆ†çµ„
                const totalWins = newBattleData.filter(b => b.result === 'å‹').length;
                const totalGames = newBattleData.length;
                const winRate = totalGames > 0 ? Math.round((totalWins / totalGames) * 100) : 0;
                
                const importMessage = `æ‰¾åˆ° ${newBattleData.length} ç­†å°æˆ°è¨˜éŒ„\n` +
                    `èµ·å§‹BPï¼š${newStartingBP}\n` +
                    `é æœŸç›®å‰BPï¼š${calculatedBP}${newCurrentBP ? `\nå¯¦éš›ç›®å‰BPï¼š${newCurrentBP}` : ''}\n` +
                    `é æœŸå‹ç‡ï¼š${winRate}% (${totalWins}å‹/${totalGames - totalWins}æ•—)\n` +
                    `${detectedGroup ? `æª¢æ¸¬åˆ°åˆ†çµ„ï¼š${detectedGroup}` : ''}\n\n` +
                    `æ˜¯å¦è¦åŒ¯å…¥ï¼Ÿé€™æœƒè¦†è“‹ç¾æœ‰æ•¸æ“šã€‚`;
                
                if (confirm(importMessage)) {
                    this.startingBP = newStartingBP;
                    this.battleData = newBattleData;
                    
                    // å¦‚æœæª¢æ¸¬åˆ°åˆ†çµ„ï¼Œè‡ªå‹•èª¿æ•´
                    if (detectedGroup && RANK_DATA[detectedGroup]) {
                        this.currentGroup = detectedGroup;
                        this.saveCurrentGroup();
                    }
                    
                    this.saveStartingBP();
                    this.saveBattleData();
                    return true;
                }
            }
            return false;
        } catch (error) {
            console.error('è§£æå°å…¥æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            throw new Error('æ•¸æ“šæ ¼å¼ä¸æ­£ç¢ºï¼Œç„¡æ³•è§£æ');
        }
    }

    // è½‰æ›èˆŠè·æ¥­åç¨±
    convertOldClassName(className) {
        const classMap = {
            'ç‹å®¤': 'çš‡å®¶',
            'å¦–ç²¾': 'ç²¾éˆ',
            'æ³•å¸«': 'å·«å¸«',
            'é¾æ—': 'é¾',
            'æ­»éˆ': 'å¤œé­”',
            'ç‰§å¸«': 'ä¸»æ•™',
            'å¾©ä»‡': 'å¾©ä»‡è€…'
        };
        return classMap[className] || className;
    }

    // å–å¾—åˆ†çµ„è®Šå‹•çµ±è¨ˆ
    getRankChangeAnalysis() {
        const analysis = {
            totalChanges: this.rankChangeHistory.length,
            upgradeCount: 0,
            downgradeCount: 0,
            changesByRank: {},
            averageGamesForChange: 0,
            winRateAtChanges: []
        };

        const rankOrder = ['ç¶ å¯¶çŸ³', 'é»ƒå¯¶çŸ³', 'ç´…å¯¶çŸ³', 'è—å¯¶çŸ³', 'é‘½çŸ³'];
        
        this.rankChangeHistory.forEach(change => {
            const fromIndex = rankOrder.indexOf(change.fromRank);
            const toIndex = rankOrder.indexOf(change.toRank);
            
            if (toIndex > fromIndex) {
                analysis.upgradeCount++;
            } else if (toIndex < fromIndex) {
                analysis.downgradeCount++;
            }

            // æŒ‰åˆ†çµ„çµ±è¨ˆ
            if (!analysis.changesByRank[change.fromRank]) {
                analysis.changesByRank[change.fromRank] = { upgrades: 0, downgrades: 0, total: 0 };
            }
            
            if (toIndex > fromIndex) {
                analysis.changesByRank[change.fromRank].upgrades++;
            } else if (toIndex < fromIndex) {
                analysis.changesByRank[change.fromRank].downgrades++;
            }
            analysis.changesByRank[change.fromRank].total++;

            analysis.winRateAtChanges.push({
                winRate: change.statsAtChange.winRate,
                games: change.statsAtChange.totalGames,
                direction: toIndex > fromIndex ? 'upgrade' : 'downgrade'
            });
        });

        if (analysis.winRateAtChanges.length > 0) {
            analysis.averageGamesForChange = Math.round(
                analysis.winRateAtChanges.reduce((sum, item) => sum + item.games, 0) / analysis.winRateAtChanges.length
            );
        }

        return analysis;
    }

    // åŒ¯å‡ºåˆ†çµ„è®Šå‹•åˆ†ææ•¸æ“š
    exportRankChangeAnalysis() {
        const analysis = this.getRankChangeAnalysis();
        const stats = this.getStatistics();
        
        let exportText = `é—‡å½±è©©ç« :å‡Œè¶Šä¸–ç•Œ åˆ†çµ„è®Šå‹•åˆ†æå ±å‘Š\n`;
        exportText += `ç”Ÿæˆæ—¥æœŸï¼š${new Date().toISOString().split('T')[0]}\n`;
        exportText += `ç›®å‰ç‹€æ…‹ï¼š${this.currentGroup} | BP: ${stats.currentBP} | å‹ç‡: ${stats.winRate}%\n\n`;
        
        exportText += `=== åˆ†çµ„è®Šå‹•çµ±è¨ˆ ===\n`;
        exportText += `ç¸½è®Šå‹•æ¬¡æ•¸ï¼š${analysis.totalChanges}\n`;
        exportText += `å‡ç´šæ¬¡æ•¸ï¼š${analysis.upgradeCount}\n`;
        exportText += `é™ç´šæ¬¡æ•¸ï¼š${analysis.downgradeCount}\n`;
        exportText += `å¹³å‡è®Šå‹•å ´æ¬¡ï¼š${analysis.averageGamesForChange}\n\n`;

        exportText += `=== å„åˆ†çµ„è®Šå‹•è©³æƒ… ===\n`;
        Object.entries(analysis.changesByRank).forEach(([rank, data]) => {
            exportText += `${rank}ï¼šå‡ç´š${data.upgrades}æ¬¡ï¼Œé™ç´š${data.downgrades}æ¬¡ï¼Œå…±${data.total}æ¬¡\n`;
        });

        exportText += `\n=== è®Šå‹•æ™‚å‹ç‡åˆ†æ ===\n`;
        const upgrades = analysis.winRateAtChanges.filter(item => item.direction === 'upgrade');
        const downgrades = analysis.winRateAtChanges.filter(item => item.direction === 'downgrade');
        
        if (upgrades.length > 0) {
            const avgUpgradeWinRate = Math.round(upgrades.reduce((sum, item) => sum + item.winRate, 0) / upgrades.length);
            exportText += `å‡ç´šæ™‚å¹³å‡å‹ç‡ï¼š${avgUpgradeWinRate}%\n`;
        }
        
        if (downgrades.length > 0) {
            const avgDowngradeWinRate = Math.round(downgrades.reduce((sum, item) => sum + item.winRate, 0) / downgrades.length);
            exportText += `é™ç´šæ™‚å¹³å‡å‹ç‡ï¼š${avgDowngradeWinRate}%\n`;
        }

        exportText += `\n=== è©³ç´°è®Šå‹•è¨˜éŒ„ ===\n`;
        this.rankChangeHistory.forEach((change, index) => {
            exportText += `${index + 1}. ç¬¬${change.battleIndex}å ´å¾Œï¼š${change.fromRank} â†’ ${change.toRank}\n`;
            exportText += `   å°æˆ°ï¼š${change.battleDetails.myClass} vs ${change.battleDetails.opponentClass} `;
            exportText += `${change.battleDetails.turnOrder || ''} ${change.battleDetails.result} (${change.battleDetails.bpChange > 0 ? '+' : ''}${change.battleDetails.bpChange}BP)\n`;
            exportText += `   ç•¶æ™‚ç‹€æ…‹ï¼šå‹ç‡${change.statsAtChange.winRate}% (${change.statsAtChange.totalGames}å ´) BP:${change.statsAtChange.currentBP}\n`;
            exportText += `   åŸå› ï¼š${change.reason}\n`;
            exportText += `   æ™‚é–“ï¼š${change.timestamp.split('T')[0]}\n\n`;
        });

        return exportText;
    }

    // æ¸…é™¤æ‰€æœ‰æ•¸æ“š
    clearAllData() {
        this.battleData = [];
        this.rankChangeHistory = [];
        this.startingBP = 50000;
        this.currentGroup = 'é’éŠ…';
        this.playerData = { ...DEFAULT_PLAYER_DATA };
        
        // æ¸…é™¤ localStorage
        localStorage.removeItem(CONFIG.STORAGE_KEYS.BATTLES);
        localStorage.removeItem(CONFIG.STORAGE_KEYS.STARTING_BP);
        localStorage.removeItem(CONFIG.STORAGE_KEYS.CURRENT_GROUP);
        localStorage.removeItem(CONFIG.STORAGE_KEYS.RANK_CHANGES);
        localStorage.removeItem(CONFIG.STORAGE_KEYS.PLAYER);
    }
}


        // === src/js/rank-manager.js ===
        // Shadowverse: Worlds Beyond Tracker - éšç´šç®¡ç†æ¨¡çµ„
// è² è²¬éšç´šè¨ˆç®—ã€å‡é™ç´šé‚è¼¯å’Œç›¸é—œåŠŸèƒ½

class RankManager {
    // è¨ˆç®—BPå°æ‡‰çš„éšç´šï¼ˆRankï¼‰
    static calculateRank(bp) {
        if (bp >= 60000) return 'Master';
        if (bp >= 50000) return 'A3';
        if (bp >= 45000) return 'A2';
        if (bp >= 40000) return 'A1';
        if (bp >= 35000) return 'B3';
        if (bp >= 30000) return 'B2';
        if (bp >= 25000) return 'B1';
        if (bp >= 20000) return 'C3';
        if (bp >= 15000) return 'C2';
        if (bp >= 10000) return 'C1';
        if (bp >= 5000) return 'D3';
        if (bp >= 2000) return 'D2';
        if (bp >= 1000) return 'D1';
        return 'Beginner';
    }

    // ç²å–ç•¶å‰åˆ†çµ„ï¼ˆGroupï¼‰ - åŸºæ–¼ç”¨æˆ¶è¨­å®šï¼ŒéBPè¨ˆç®—
    static getCurrentGroup() {
        return localStorage.getItem(CONFIG.STORAGE_KEYS.CURRENT_GROUP) || CONFIG.DEFAULTS.CURRENT_GROUP;
    }

    // è¨­å®šç•¶å‰åˆ†çµ„
    static setCurrentGroup(group) {
        localStorage.setItem(CONFIG.STORAGE_KEYS.CURRENT_GROUP, group);
    }

    // è‡ªå‹•åˆ†çµ„èª¿æ•´é‚è¼¯ï¼ˆåŸºæ–¼åˆ†çµ„Groupï¼Œééšç´šRankï¼‰
    // æ³¨æ„ï¼šæ­¤åŠŸèƒ½ç›®å‰ç‚ºå¯¦é©—æ€§è³ªï¼Œåˆ†çµ„å‡é™è¦å‰‡å°šæœªå®Œå–„
    // å»ºè­°ä½¿ç”¨æ‰‹å‹•åˆ†çµ„æ¨™è¨˜åŠŸèƒ½ä»¥ç²å¾—æ›´æº–ç¢ºçš„åˆ†çµ„è¿½è¹¤
    static autoAdjustGroup(winRate, totalGames, currentGroup, lastMatchResult = null) {
        // éœ€è¦è‡³å°‘15å ´å°æˆ°æ‰é–‹å§‹åˆ†çµ„èª¿æ•´
        if (totalGames < CONFIG.GAME_RULES.MIN_GAMES_FOR_RANK_ADJUSTMENT) {
            return currentGroup;
        }
        
        // TODO: éœ€è¦æ›´å¤šå¯¦éš›éŠæˆ²æ•¸æ“šä¾†å®Œå–„å‡é™ç´šè¦å‰‡
        // ç›®å‰çš„é‚è¼¯åƒ…ç‚ºåŸºç¤ä¼°ç®—ï¼Œå¯èƒ½èˆ‡å¯¦éš›éŠæˆ²è¦å‰‡æœ‰å·®ç•°
        
        const groupOrder = ['ç¶ å¯¶çŸ³', 'é»ƒå¯¶çŸ³', 'ç´…å¯¶çŸ³', 'è—å¯¶çŸ³', 'é‘½çŸ³'];
        const currentIndex = groupOrder.indexOf(currentGroup);
        const currentGroupData = RANK_DATA[currentGroup];
        
        // åš´æ ¼æ‰ç´šæ¢ä»¶ï¼šå‹ç‡é ä½æ–¼è­¦æˆ’ç·š
        if (winRate < currentGroupData.danger - 5 && totalGames >= CONFIG.GAME_RULES.MIN_GAMES_FOR_RANK_DANGER) {
            if (currentIndex > 0) {
                return groupOrder[currentIndex - 1];
            }
        }
        
        // è‡¨ç•Œæ‰ç´šæ¢ä»¶
        if (totalGames >= CONFIG.GAME_RULES.MIN_GAMES_FOR_RANK_DANGER && currentIndex > 0) {
            if (winRate < currentGroupData.maintain) {
                const isDangerZone = winRate <= Math.max(currentGroupData.danger + 5, 50);
                const isBlueGroup50 = (currentGroup === 'è—å¯¶çŸ³' && winRate === 50);
                
                if ((isDangerZone || isBlueGroup50) && lastMatchResult === 'æ•—') {
                    return groupOrder[currentIndex - 1];
                }
            }
        }
        
        // å‡ç´šæ¢ä»¶
        if (winRate >= currentGroupData.maintain + 10 && 
            currentIndex < groupOrder.length - 1 && 
            totalGames >= CONFIG.GAME_RULES.MIN_GAMES_FOR_RANK_ADJUSTMENT) {
            const nextGroupData = RANK_DATA[groupOrder[currentIndex + 1]];
            if (winRate >= nextGroupData.maintain) {
                return groupOrder[currentIndex + 1];
            }
        }
        
        return currentGroup;
    }

    // é¡¯ç¤ºåˆ†çµ„è®Šæ›´é€šçŸ¥
    static showGroupChangeNotification(oldGroup, newGroup, winRate) {
        const oldGroupData = RANK_DATA[oldGroup];
        const newGroupData = RANK_DATA[newGroup];
        
        const groupOrder = ['ç¶ å¯¶çŸ³', 'é»ƒå¯¶çŸ³', 'ç´…å¯¶çŸ³', 'è—å¯¶çŸ³', 'é‘½çŸ³'];
        const isUpgrade = groupOrder.indexOf(newGroup) > groupOrder.indexOf(oldGroup);
        
        const message = isUpgrade 
            ? `ğŸ‰ æ­å–œå‡ç´šï¼\n${oldGroupData.icon} ${oldGroupData.name} â†’ ${newGroupData.icon} ${newGroupData.name}\n\nç›®å‰å‹ç‡ï¼š${winRate}%\nè«‹ç¹¼çºŒä¿æŒå„ªç§€è¡¨ç¾ï¼`
            : `ğŸ“‰ åˆ†çµ„èª¿æ•´é€šçŸ¥\n${oldGroupData.icon} ${oldGroupData.name} â†’ ${newGroupData.icon} ${newGroupData.name}\n\nç›®å‰å‹ç‡ï¼š${winRate}%\nå»ºè­°æå‡å‹ç‡ä»¥é‡å›æ›´é«˜åˆ†çµ„ï¼`;
        
        alert(message);
    }

    // åˆ†æåˆ†çµ„ç‹€æ…‹
    static analyzeGroupStatus(winRate, totalGames, currentGroup) {
        const group = RANK_DATA[currentGroup];
        const maintainThreshold = group.maintain;
        const dangerThreshold = group.danger;
        
        // å¦‚æœå ´æ¬¡å¤ªå°‘ï¼Œçµ¦äºˆæç¤º
        if (totalGames < CONFIG.GAME_RULES.MIN_GAMES_FOR_RANK_ADJUSTMENT) {
            return {
                status: 'ğŸ“Š æ•¸æ“šæ”¶é›†ä¸­',
                statusClass: 'rank-safe',
                analysis: `ç›®å‰æœ‰${totalGames}å ´å°æˆ°è¨˜éŒ„ï¼Œå»ºè­°è‡³å°‘é€²è¡Œ${CONFIG.GAME_RULES.MIN_GAMES_FOR_RANK_ADJUSTMENT}å ´å°æˆ°å¾Œç³»çµ±æ‰æœƒé€²è¡Œåˆ†çµ„èª¿æ•´è©•ä¼°ã€‚`
            };
        }

        let status, statusClass, analysis;

        if (winRate >= maintainThreshold + 10) {
            status = 'âœ… åˆ†çµ„éå¸¸ç©©å®š';
            statusClass = 'rank-safe';
            analysis = `æ‚¨çš„${winRate}%å‹ç‡åœ¨${group.name}åˆ†çµ„ä¸­è¡¨ç¾å„ªç•°ï¼Œå®Œå…¨ä¸ç”¨æ“”å¿ƒæ‰ç´šå•é¡Œã€‚`;
            
            // æª¢æŸ¥æ˜¯å¦å¯ä»¥å‡ç´š
            const groupOrder = ['ç¶ å¯¶çŸ³', 'é»ƒå¯¶çŸ³', 'ç´…å¯¶çŸ³', 'è—å¯¶çŸ³', 'é‘½çŸ³'];
            const currentIndex = groupOrder.indexOf(currentGroup);
            if (currentIndex < groupOrder.length - 1) {
                const nextGroup = groupOrder[currentIndex + 1];
                const nextGroupData = RANK_DATA[nextGroup];
                if (winRate >= nextGroupData.maintain) {
                    analysis += ` æ‚¨çš„å‹ç‡å·²é”åˆ°${nextGroupData.name}åˆ†çµ„æ¨™æº–ï¼Œç³»çµ±å¯èƒ½æœƒè‡ªå‹•å‡ç´šã€‚`;
                }
            }
        } else if (winRate >= maintainThreshold) {
            status = 'âœ… åˆ†çµ„å®‰å…¨';
            statusClass = 'rank-safe';
            analysis = `æ‚¨çš„${winRate}%å‹ç‡åœ¨${group.name}åˆ†çµ„ä¸­è¡¨ç¾è‰¯å¥½ï¼Œå»ºè­°ç¹¼çºŒä¿æŒã€‚`;
        } else if (winRate >= maintainThreshold - 5) {
            status = 'âš ï¸ éœ€è¦æ³¨æ„';
            statusClass = 'rank-warning';
            analysis = `æ‚¨çš„${winRate}%å‹ç‡ç•¥ä½æ–¼${group.name}åˆ†çµ„å»ºè­°æ¨™æº–(${maintainThreshold}%)ï¼Œå»ºè­°æå‡å‹ç‡ã€‚`;
        } else if (winRate >= dangerThreshold) {
            status = 'ğŸš¨ æ‰ç´šé¢¨éšª';
            statusClass = 'rank-danger';
            
            if (totalGames >= CONFIG.GAME_RULES.MIN_GAMES_FOR_RANK_DANGER) {
                const isDangerZone = winRate <= Math.max(dangerThreshold + 5, 50);
                const isBlueGroup50 = (currentGroup === 'è—å¯¶çŸ³' && winRate === 50);
                
                if (isDangerZone || isBlueGroup50) {
                    analysis = `æ‚¨çš„${winRate}%å‹ç‡å·²åœ¨è‡¨ç•Œå€åŸŸï¼Œä¸‹ä¸€å ´æ•—æˆ°å¯èƒ½è§¸ç™¼æ‰ç´šæ©Ÿåˆ¶ã€‚`;
                } else {
                    analysis = `æ‚¨çš„${winRate}%å‹ç‡æ¥è¿‘æ‰ç´šè­¦æˆ’ç·š(${dangerThreshold}%)ï¼Œå»ºè­°ç›¡å¿«æå‡å‹ç‡ã€‚`;
                }
            } else {
                analysis = `æ‚¨çš„${winRate}%å‹ç‡æ¥è¿‘æ‰ç´šè­¦æˆ’ç·šï¼Œä½†é‚„éœ€è¦${CONFIG.GAME_RULES.MIN_GAMES_FOR_RANK_DANGER - totalGames}å ´å°æˆ°æ‰æœƒè§¸ç™¼åˆ†çµ„èª¿æ•´ã€‚`;
            }
        } else {
            status = 'ğŸ’¥ æ¥µåº¦å±éšª';
            statusClass = 'rank-danger';
            if (totalGames >= CONFIG.GAME_RULES.MIN_GAMES_FOR_RANK_DANGER) {
                analysis = `æ‚¨çš„${winRate}%å‹ç‡æ¥µä½ï¼Œç³»çµ±å·²è‡ªå‹•èª¿æ•´åˆ†çµ„ã€‚å»ºè­°èª¿æ•´ç­–ç•¥é‡å›æ›´é«˜åˆ†çµ„ã€‚`;
            } else {
                analysis = `æ‚¨çš„${winRate}%å‹ç‡æ¥µä½ï¼Œé‚„æœ‰${CONFIG.GAME_RULES.MIN_GAMES_FOR_RANK_DANGER - totalGames}å ´ç·©è¡æœŸã€‚è«‹ç«‹å³èª¿æ•´ç­–ç•¥æå‡å‹ç‡ï¼`;
            }
        }

        return { status, statusClass, analysis };
    }

    // ç”Ÿæˆå‹ç‡é æ¸¬
    static generatePredictions(wins, totalGames, winRate, maintainThreshold, dangerThreshold, currentGroup) {
        const lose5 = Math.round(((wins) / (totalGames + 5)) * 100);
        const win5 = Math.round(((wins + 5) / (totalGames + 5)) * 100);
        
        let prediction = '';
        
        // ç‰¹åˆ¥æé†’è‡¨ç•Œæ‰ç´šé¢¨éšª
        if (totalGames >= CONFIG.GAME_RULES.MIN_GAMES_FOR_RANK_DANGER && winRate < maintainThreshold) {
            const isDangerZone = winRate <= Math.max(dangerThreshold + 5, 50);
            const isBlueGroup50 = (currentGroup === 'è—å¯¶çŸ³' && winRate === 50);
            
            if (isDangerZone || isBlueGroup50) {
                prediction += `â€¢ ğŸš¨ <strong>æ‰ç´šé¢¨éšªè­¦å‘Š</strong>ï¼šæ‚¨çš„å‹ç‡å·²åœ¨è‡¨ç•Œå€åŸŸï¼Œä¸‹ä¸€å ´æ•—æˆ°å¯èƒ½è§¸ç™¼æ‰ç´šï¼<br>`;
            }
        }
        
        if (lose5 < dangerThreshold - 5) {
            prediction += `â€¢ âš ï¸ å¦‚æœæ¥ä¸‹ä¾†5å ´å…¨æ•—ï¼Œå‹ç‡å°‡é™è‡³${lose5}%ï¼Œæœ‰åš´é‡æ‰ç´šé¢¨éšª<br>`;
        } else if (lose5 < dangerThreshold) {
            prediction += `â€¢ âš ï¸ å¦‚æœæ¥ä¸‹ä¾†5å ´å…¨æ•—ï¼Œå‹ç‡å°‡é™è‡³${lose5}%ï¼Œæœ‰æ‰ç´šé¢¨éšª<br>`;
        } else {
            prediction += `â€¢ å¦‚æœæ¥ä¸‹ä¾†5å ´å…¨æ•—ï¼Œå‹ç‡å°‡é™è‡³${lose5}%<br>`;
        }
        
        prediction += `â€¢ å¦‚æœæ¥ä¸‹ä¾†5å ´å…¨å‹ï¼Œå‹ç‡å°‡å‡è‡³${win5}%`;
        
        if (win5 >= maintainThreshold + 10) {
            prediction += 'ï¼Œåˆ†çµ„å°‡éå¸¸ç©©å®š';
        } else if (win5 >= maintainThreshold) {
            prediction += 'ï¼Œåˆ†çµ„å°‡å¾ˆå®‰å…¨';
        }
        
        return prediction;
    }
}


        // === src/js/ui-controller.js ===
        // Shadowverse: Worlds Beyond Tracker - UIæ§åˆ¶å™¨
// è² è²¬æ‰€æœ‰UIæ›´æ–°ã€äº‹ä»¶è™•ç†å’Œé¢æ¿ç®¡ç†

class UIController {
    constructor() {
        this.init();
    }

    // åˆå§‹åŒ–UI
    init() {
        this.initPlayerData();
        this.updateStats();
        this.renderBattles();
        this.bindEvents();
    }

    // é¢æ¿åˆ‡æ›åŠŸèƒ½
    showPanel(panelName) {
        // éš±è—æ‰€æœ‰é¢æ¿
        document.querySelectorAll('.panel').forEach(panel => {
            panel.classList.remove('active');
        });
        
        // ç§»é™¤æ‰€æœ‰å°èˆªæŒ‰éˆ•çš„active class
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // é¡¯ç¤ºæŒ‡å®šé¢æ¿
        const targetPanel = document.getElementById(panelName + 'Panel');
        if (targetPanel) {
            targetPanel.classList.add('active');
        }
        
        // è¨­å®šå°æ‡‰å°èˆªæŒ‰éˆ•ç‚ºactive
        // æ‰¾åˆ°å°æ‡‰çš„å°èˆªæŒ‰éˆ•ä¸¦è¨­ç‚ºactive
        const navButtons = document.querySelectorAll('.nav-btn');
        navButtons.forEach(btn => {
            if (btn.onclick && btn.onclick.toString().includes(panelName)) {
                btn.classList.add('active');
            }
        });
        
        // å¦‚æœæ˜¯çŸ©é™£é¢æ¿ï¼Œæ¸²æŸ“çŸ©é™£æ•¸æ“š
        if (panelName === 'matrix') {
            this.renderMatrix();
        }
    }

    // åˆå§‹åŒ–ç©å®¶è³‡æ–™é¡¯ç¤º
    initPlayerData() {
        const elements = [
            'playerName', 'gameId', 'registerDate', 'mainClass', 
            'targetRank', 'targetWinRate', 'monthlyTarget', 'targetBP',
            'highestRank', 'highestBP', 'longestWinStreak', 'totalPlayTime'
        ];

        elements.forEach(id => {
            const element = document.getElementById(id);
            if (element && dataManager.playerData[id]) {
                element.textContent = dataManager.playerData[id];
            }
        });
    }

    // æ›´æ–°çµ±è¨ˆè³‡è¨Š
    updateStats() {
        const stats = dataManager.getStatistics();
        
        // æª¢æŸ¥åˆ†çµ„è‡ªå‹•èª¿æ•´
        const oldGroup = dataManager.currentGroup;
        const newGroup = RankManager.autoAdjustGroup(
            stats.winRate, 
            stats.totalGames, 
            dataManager.currentGroup, 
            stats.lastMatchResult
        );

        if (newGroup !== dataManager.currentGroup) {
            console.log(`åˆ†çµ„è‡ªå‹•èª¿æ•´ï¼š${dataManager.currentGroup} â†’ ${newGroup} (å‹ç‡: ${stats.winRate}%, æœ€å¾Œä¸€å ´: ${stats.lastMatchResult})`);
            dataManager.currentGroup = newGroup;
            dataManager.saveCurrentGroup();
            RankManager.showGroupChangeNotification(oldGroup, newGroup, stats.winRate);
        }

        // æ›´æ–°é¡¯ç¤ºå…ƒç´ 
        const currentRankLevel = RankManager.calculateRank(stats.currentBP);
        const streakText = stats.streak + (stats.streakType === 'å‹' ? 'é€£å‹' : 'é€£æ•—');

        this.updateElement('currentBP', stats.currentBP.toLocaleString());
        this.updateElement('startingBP', dataManager.startingBP.toLocaleString());
        this.updateElement('currentRank', `${GROUP_DATA[dataManager.currentGroup].icon} ${GROUP_DATA[dataManager.currentGroup].name}`);
        this.updateElement('currentRankLevel', currentRankLevel);
        this.updateElement('totalGames', stats.totalGames);
        this.updateElement('winRate', stats.winRate + '%');
        
        // æ›´æ–°å…ˆæ‰‹å¾Œæ‰‹å‹ç‡
        this.updateElement('firstWinRate', stats.firstTurnGames > 0 ? `${stats.firstWinRate}%` : '--');
        this.updateElement('secondWinRate', stats.secondTurnGames > 0 ? `${stats.secondWinRate}%` : '--');
        
        this.updateElement('streak', streakText);

        this.updateRankCalculator(stats.totalGames, stats.wins, stats.winRate);
    }

    // æ›´æ–°éšç´šè¨ˆç®—å™¨
    updateRankCalculator(totalGames, wins, winRate) {
        const rankStatusText = document.getElementById('rankStatusText');
        const rankProgress = document.getElementById('rankProgress');
        const rankAnalysis = document.getElementById('rankAnalysis');
        const rankPrediction = document.getElementById('rankPrediction');
        
        if (!rankStatusText || !rankProgress || !rankAnalysis || !rankPrediction) return;

        const rank = RANK_DATA[dataManager.currentGroup];
        const { status, statusClass, analysis } = RankManager.analyzeGroupStatus(winRate, totalGames, dataManager.currentGroup);
        
        // è¨­å®šé€²åº¦æ¢å¯¬åº¦
        rankProgress.style.width = winRate + '%';
        
        // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
        rankStatusText.textContent = status;
        rankStatusText.className = statusClass;
        rankAnalysis.textContent = analysis;
        
        // æ›´æ–°é æ¸¬
        const prediction = RankManager.generatePredictions(
            wins, totalGames, winRate, 
            rank.maintain, rank.danger, dataManager.currentGroup
        );
        rankPrediction.innerHTML = prediction;
    }

    // æ¸²æŸ“å°æˆ°è¨˜éŒ„
    renderBattles() {
        const battleList = document.getElementById('battleList');
        if (!battleList) return;

        battleList.innerHTML = '';
        
        dataManager.battleData.slice().reverse().forEach((battle, reverseIndex) => {
            const battleIndex = dataManager.battleData.length - 1 - reverseIndex; // å¯¦éš›ç´¢å¼•
            const battleItem = document.createElement('div');
            battleItem.className = 'battle-item';
            
            // å…ˆæ‰‹å¾Œæ‰‹é¡¯ç¤º
            const turnInfo = battle.turnOrder ? `<span class="turn-order ${battle.turnOrder}">${battle.turnOrder}</span>` : '';
            
            // æª¢æŸ¥æ˜¯å¦å·²æ¨™è¨˜åˆ†çµ„è®Šå‹•
            const isMarked = dataManager.rankChangeHistory.some(change => change.battleId === battle.id);
            const markButton = `<button class="rank-change-btn ${isMarked ? 'marked' : ''}" 
                onclick="toggleRankChange(${battleIndex}, ${battle.id})" 
                title="${isMarked ? 'å·²æ¨™è¨˜åˆ†çµ„è®Šå‹•' : 'æ¨™è¨˜åˆ†çµ„è®Šå‹•'}">
                ${isMarked ? 'ğŸ“' : 'ğŸ“Œ'}
            </button>`;
            
            // ç·¨è¼¯å’Œåˆªé™¤æŒ‰éˆ•
            const editButton = `<button class="edit-btn" onclick="editBattle(${battle.id})" title="ç·¨è¼¯å°æˆ°è¨˜éŒ„">âœï¸</button>`;
            const deleteButton = `<button class="delete-btn" onclick="deleteBattle(${battle.id})" title="åˆªé™¤å°æˆ°è¨˜éŒ„">ğŸ—‘ï¸</button>`;
            
            battleItem.innerHTML = `
                <div class="battle-info">
                    <span class="èŒä¸š-icon ${battle.myClass}">${battle.myClass}</span> vs 
                    <span class="èŒä¸š-icon ${battle.opponentClass}">${battle.opponentClass}</span>
                    ${turnInfo}
                    <span class="bp-change">${battle.bpChange > 0 ? '+' : ''}${battle.bpChange}BP</span>
                    <small style="color: #ccc;">${battle.timestamp}</small>
                    <div class="battle-actions">
                        ${markButton}
                        ${editButton}
                        ${deleteButton}
                    </div>
                </div>
                <div class="battle-result ${battle.result === 'å‹' ? 'win' : 'lose'}">
                    ${battle.result}
                </div>
            `;
            battleList.appendChild(battleItem);
        });
    }

    // æ–°å¢å°æˆ°è¨˜éŒ„
    addBattle() {
        const myClass = document.getElementById('myClass')?.value;
        const opponentClass = document.getElementById('opponentClass')?.value;
        const turnOrder = document.getElementById('turnOrder')?.value;
        const result = document.getElementById('result')?.value;
        const bpChangeInput = document.getElementById('bpChange');
        const bpValue = bpChangeInput?.value.trim().replace(/^\+/, ''); // ç§»é™¤å‰å°+è™Ÿå’Œç©ºç™½
        
        // é©—è­‰å¿…å¡«æ¬„ä½
        if (!turnOrder) {
            alert('è«‹é¸æ“‡å…ˆæ‰‹æˆ–å¾Œæ‰‹ï¼');
            document.getElementById('turnOrder')?.focus();
            return;
        }
        
        if (!result) {
            alert('è«‹é¸æ“‡å°æˆ°çµæœï¼');
            document.getElementById('result')?.focus();
            return;
        }
        
        // ä¿®æ­£BPé©—è­‰é‚è¼¯ï¼šå…è¨±0å€¼ï¼Œä½†ä¸å…è¨±ç©ºå€¼æˆ–ç„¡æ•ˆæ•¸å­—
        if (bpValue === '' || bpValue === null || bpValue === undefined) {
            alert('è«‹è¼¸å…¥BPè®ŠåŒ–å€¼ï¼');
            bpChangeInput?.focus();
            bpChangeInput?.classList.add('error');
            return;
        }
        
        const bpChange = parseInt(bpValue);
        if (isNaN(bpChange)) {
            alert('BPè®ŠåŒ–å€¼å¿…é ˆæ˜¯æœ‰æ•ˆæ•¸å­—ï¼');
            bpChangeInput?.focus();
            bpChangeInput?.select();
            bpChangeInput?.classList.add('error');
            return;
        }
        
        // é©—è­‰BPå€¼ç¯„åœ
        if (Math.abs(bpChange) > 1000) {
            const confirmMsg = `BPè®ŠåŒ–å€¼ ${bpChange} ä¼¼ä¹å¾ˆå¤§ï¼Œæ˜¯å¦ç¢ºèªç„¡èª¤ï¼Ÿ`;
            if (!confirm(confirmMsg)) {
                bpChangeInput?.focus();
                bpChangeInput?.select();
                return;
            }
        }
        
        const newBattle = {
            myClass,
            opponentClass,
            turnOrder,
            result,
            bpChange
        };
        
        dataManager.addBattle(newBattle);
        
        // æˆåŠŸæç¤º
        bpChangeInput?.classList.remove('error', 'warning');
        bpChangeInput?.classList.add('success');
        setTimeout(() => {
            bpChangeInput?.classList.remove('success');
        }, 1000);
        
        // æ¸…ç©ºè¡¨å–®
        if (bpChangeInput) bpChangeInput.value = '';
        document.getElementById('turnOrder').value = '';
        document.getElementById('result').value = '';
        
        this.updateStats();
        this.renderBattles();
        
        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        this.showToast('å°æˆ°è¨˜éŒ„å·²æ–°å¢ï¼', 'success');
    }

    // ç·¨è¼¯èµ·å§‹BP
    editStartingBP() {
        const newStartingBP = prompt('è«‹è¼¸å…¥æ–°çš„èµ·å§‹BPï¼š', dataManager.startingBP);
        
        if (newStartingBP !== null && !isNaN(newStartingBP) && newStartingBP !== '') {
            const parsedBP = parseInt(newStartingBP);
            if (parsedBP >= 0) {
                dataManager.startingBP = parsedBP;
                dataManager.saveStartingBP();
                this.updateStats();
                
                // æ·»åŠ è¦–è¦ºåé¥‹
                const startingBPElement = document.getElementById('startingBP');
                if (startingBPElement) {
                    startingBPElement.style.transform = 'scale(1.1)';
                    startingBPElement.style.color = '#4CAF50';
                    setTimeout(() => {
                        startingBPElement.style.transform = 'scale(1)';
                        startingBPElement.style.color = '#ffd700';
                    }, 500);
                }
            } else {
                alert('BPä¸èƒ½ç‚ºè² æ•¸ï¼');
            }
        }
    }

    // ç·¨è¼¯ç•¶å‰éšç´š
    editCurrentRank() {
        const newRank = prompt(
            `è«‹é¸æ“‡ç›®å‰åˆ†çµ„ï¼š\n\nå¯é¸åˆ†çµ„ï¼š\nğŸŸ¢ ç¶ å¯¶çŸ³\nğŸŸ  é»ƒå¯¶çŸ³\nğŸ”´ ç´…å¯¶çŸ³\nğŸ”µ è—å¯¶çŸ³\nğŸ’ é‘½çŸ³\n\nè«‹è¼¸å…¥åˆ†çµ„åç¨±ï¼ˆä¾‹ï¼šé‘½çŸ³ï¼‰ï¼š`,
            RANK_DATA[dataManager.currentRank].name
        );
        
        if (newRank !== null) {
            const rankKey = Object.keys(RANK_DATA).find(key => RANK_DATA[key].name === newRank.trim());
            if (rankKey) {
                dataManager.currentRank = rankKey;
                dataManager.saveCurrentRank();
                this.updateStats();
                
                // æ·»åŠ è¦–è¦ºåé¥‹
                const currentRankElement = document.getElementById('currentRank');
                if (currentRankElement) {
                    currentRankElement.style.transform = 'scale(1.1)';
                    currentRankElement.style.color = '#4CAF50';
                    setTimeout(() => {
                        currentRankElement.style.transform = 'scale(1)';
                        currentRankElement.style.color = '#ffd700';
                    }, 500);
                }
            } else {
                alert('è«‹è¼¸å…¥æ­£ç¢ºçš„åˆ†çµ„åç¨±ï¼');
            }
        }
    }

    // ç©å®¶è³‡æ–™ç·¨è¼¯å‡½æ•¸
    editPlayerName() {
        this.editPlayerField('name', 'è«‹è¼¸å…¥ç©å®¶åç¨±ï¼š', 'playerName');
    }

    editGameId() {
        this.editPlayerField('gameId', 'è«‹è¼¸å…¥éŠæˆ²IDï¼š', 'gameId');
    }

    editMainClass() {
        const classes = Object.keys(CLASS_DATA);
        const newClass = prompt('è«‹é¸æ“‡ä¸»è¦è·æ¥­ï¼š\n' + classes.join(', '), dataManager.playerData.mainClass);
        if (newClass !== null && classes.includes(newClass.trim())) {
            this.editPlayerField('mainClass', null, 'mainClass', newClass.trim());
        }
    }

    editTargetRank() {
        const ranks = Object.keys(RANK_DATA);
        const current = dataManager.playerData.targetRank || 'é‘½çŸ³';
        const newValue = prompt('è«‹é¸æ“‡ç›®æ¨™åˆ†çµ„ (' + ranks.join('/') + '):', current);
        if (newValue && ranks.includes(newValue)) {
            dataManager.playerData.targetRank = newValue;
            dataManager.savePlayerData();
            this.initPlayerData();
        }
    }

    // é€šç”¨ç©å®¶è³‡æ–™ç·¨è¼¯
    editPlayerField(field, promptText, elementId, value = null) {
        const newValue = value || (promptText ? prompt(promptText, dataManager.playerData[field]) : null);
        if (newValue !== null && newValue.trim() !== '') {
            dataManager.playerData[field] = newValue.trim();
            this.updateElement(elementId, dataManager.playerData[field]);
            dataManager.savePlayerData();
            this.showSaveStatus('âœ… è³‡æ–™å·²è‡ªå‹•ä¿å­˜', '#4caf50');
        }
    }

    // ç©å®¶è³‡æ–™ç®¡ç†åŠŸèƒ½
    savePlayerProfile() {
        try {
            dataManager.savePlayerData();
            this.showSaveStatus('âœ… ç©å®¶è³‡æ–™å·²ä¿å­˜', '#4caf50');
            console.log('ç©å®¶è³‡æ–™ä¿å­˜æˆåŠŸ');
        } catch (error) {
            this.showSaveStatus('âŒ ä¿å­˜å¤±æ•—', '#f44336');
            console.error('ç©å®¶è³‡æ–™ä¿å­˜å¤±æ•—:', error);
        }
    }

    resetPlayerProfile() {
        if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰ç©å®¶è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
            try {
                // é‡ç½®ç©å®¶è³‡æ–™ç‚ºé è¨­å€¼
                dataManager.playerData = { ...DEFAULT_PLAYER_DATA };
                dataManager.savePlayerData();
                this.initPlayerData(); // é‡æ–°è¼‰å…¥é¡¯ç¤º
                this.showSaveStatus('âœ… ç©å®¶è³‡æ–™å·²é‡ç½®', '#ff9800');
                console.log('ç©å®¶è³‡æ–™é‡ç½®æˆåŠŸ');
            } catch (error) {
                this.showSaveStatus('âŒ é‡ç½®å¤±æ•—', '#f44336');
                console.error('ç©å®¶è³‡æ–™é‡ç½®å¤±æ•—:', error);
            }
        }
    }

    // åŒ¯å‡ºæ‰€æœ‰æ•¸æ“šï¼ˆåŒ…å«åˆ†çµ„æ¨™è¨˜ï¼‰
    exportData() {
        try {
            const exportData = {
                metadata: {
                    appName: 'Shadowverse: Worlds Beyond Tracker',
                    version: CONFIG.VERSION,
                    exportDate: new Date().toISOString(),
                    totalBattles: dataManager.battleData.length,
                    totalRankChanges: dataManager.rankChangeHistory.length
                },
                playerData: dataManager.playerData,
                battleData: dataManager.battleData,
                startingBP: dataManager.startingBP,
                currentGroup: dataManager.currentGroup,
                rankChanges: dataManager.rankChangeHistory, // é‡è¦ï¼šåˆ†çµ„è®Šå‹•æ¨™è¨˜
                statistics: this.generateExportStatistics()
            };
            
            // ç”Ÿæˆæª”æ¡ˆåç¨±
            const fileName = `shadowverse_data_${new Date().toISOString().split('T')[0]}.json`;
            
            // ä¸‹è¼‰ JSON æª”æ¡ˆ
            this.downloadJSON(exportData, fileName);
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            this.showToast('âœ… æ•¸æ“šåŒ¯å‡ºæˆåŠŸï¼åŒ…å«æ‰€æœ‰å°æˆ°è¨˜éŒ„å’Œåˆ†çµ„æ¨™è¨˜', 'success');
            
            console.log('æ•¸æ“šåŒ¯å‡ºå®Œæˆ:', fileName);
            
        } catch (error) {
            console.error('åŒ¯å‡ºæ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            this.showToast('âŒ åŒ¯å‡ºå¤±æ•—ï¼š' + error.message, 'error');
        }
    }

    // åŒ¯å‡ºåˆ†çµ„è®Šå‹•åˆ†æ
    exportRankAnalysis() {
        try {
            const analysis = this.generateRankAnalysis();
            const fileName = `shadowverse_rank_analysis_${new Date().toISOString().split('T')[0]}.json`;
            
            this.downloadJSON(analysis, fileName);
            this.showToast('âœ… åˆ†çµ„åˆ†æåŒ¯å‡ºæˆåŠŸï¼', 'success');
            
            console.log('åˆ†çµ„åˆ†æåŒ¯å‡ºå®Œæˆ:', fileName);
            
        } catch (error) {
            console.error('åŒ¯å‡ºåˆ†çµ„åˆ†ææ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            this.showToast('âŒ åŒ¯å‡ºå¤±æ•—ï¼š' + error.message, 'error');
        }
    }

    // ç”ŸæˆåŒ¯å‡ºçµ±è¨ˆè³‡æ–™
    generateExportStatistics() {
        const battles = dataManager.battleData;
        const wins = battles.filter(b => b.result === 'win').length;
        const losses = battles.filter(b => b.result === 'loss').length;
        const firstHandWins = battles.filter(b => b.firstHand && b.result === 'win').length;
        const firstHandTotal = battles.filter(b => b.firstHand).length;
        const secondHandWins = battles.filter(b => !b.firstHand && b.result === 'win').length;
        const secondHandTotal = battles.filter(b => !b.firstHand).length;

        return {
            totalBattles: battles.length,
            wins: wins,
            losses: losses,
            winRate: battles.length > 0 ? ((wins / battles.length) * 100).toFixed(1) + '%' : '0%',
            firstHandWinRate: firstHandTotal > 0 ? ((firstHandWins / firstHandTotal) * 100).toFixed(1) + '%' : '0%',
            secondHandWinRate: secondHandTotal > 0 ? ((secondHandWins / secondHandTotal) * 100).toFixed(1) + '%' : '0%',
            currentBP: this.calculateCurrentBP(),
            bpChange: this.calculateCurrentBP() - dataManager.startingBP
        };
    }

    // ç”Ÿæˆåˆ†çµ„è®Šå‹•åˆ†æå ±å‘Š
    generateRankAnalysis() {
        const battles = dataManager.battleData;
        const rankChanges = dataManager.rankChangeHistory;
        
        const analysis = {
            metadata: {
                appName: 'Shadowverse: Worlds Beyond Tracker - åˆ†çµ„è®Šå‹•åˆ†æ',
                version: CONFIG.VERSION,
                exportDate: new Date().toISOString(),
                analysisType: 'rank_changes'
            },
            summary: {
                totalBattles: battles.length,
                rankChangesCount: rankChanges.length,
                currentGroup: dataManager.currentGroup,
                startingBP: dataManager.startingBP,
                currentBP: this.calculateCurrentBP()
            },
            rankChanges: rankChanges.map((change, index) => {
                const segmentBattles = this.getRankChangeSegmentBattles(change);
                return {
                    changeIndex: index + 1,
                    battleIndex: change.battleIndex,
                    fromRank: change.fromRank,
                    toRank: change.toRank,
                    changeType: change.changeType || 'unknown',
                    triggerBP: change.triggerBP,
                    timestamp: change.timestamp,
                    segmentAnalysis: this.analyzeRankChangeSegment(segmentBattles),
                    battles: segmentBattles
                };
            }),
            recommendations: this.generateRankChangeRecommendations(rankChanges)
        };
        
        return analysis;
    }

    // ç²å–åˆ†çµ„è®Šå‹•å€æ®µçš„å°æˆ°æ•¸æ“š
    getRankChangeSegmentBattles(rankChange) {
        const battles = dataManager.battleData;
        const changeIndex = rankChange.battleIndex;
        
        // å–å¾—è®Šå‹•å‰å¾Œçš„å°æˆ°å€æ®µï¼ˆä¾‹å¦‚å‰10å ´åˆ°è®Šå‹•å ´æ¬¡ï¼‰
        const segmentSize = 10;
        const startIndex = Math.max(0, changeIndex - segmentSize);
        const endIndex = Math.min(battles.length, changeIndex + 1);
        
        return battles.slice(startIndex, endIndex);
    }

    // åˆ†æåˆ†çµ„è®Šå‹•å€æ®µ
    analyzeRankChangeSegment(segmentBattles) {
        if (!segmentBattles || segmentBattles.length === 0) {
            return { error: 'ç„¡å°æˆ°æ•¸æ“š' };
        }

        const wins = segmentBattles.filter(b => b.result === 'win').length;
        const losses = segmentBattles.filter(b => b.result === 'loss').length;
        const winRate = ((wins / segmentBattles.length) * 100).toFixed(1);
        
        const firstHandBattles = segmentBattles.filter(b => b.firstHand);
        const firstHandWins = firstHandBattles.filter(b => b.result === 'win').length;
        const firstHandWinRate = firstHandBattles.length > 0 ? 
            ((firstHandWins / firstHandBattles.length) * 100).toFixed(1) : '0';
        
        const secondHandBattles = segmentBattles.filter(b => !b.firstHand);
        const secondHandWins = secondHandBattles.filter(b => b.result === 'win').length;
        const secondHandWinRate = secondHandBattles.length > 0 ? 
            ((secondHandWins / secondHandBattles.length) * 100).toFixed(1) : '0';

        const totalBPChange = segmentBattles.reduce((sum, battle) => {
            const bp = parseInt(battle.bpChange) || 0;
            return sum + bp;
        }, 0);

        return {
            battleCount: segmentBattles.length,
            wins: wins,
            losses: losses,
            winRate: winRate + '%',
            firstHandWinRate: firstHandWinRate + '%',
            secondHandWinRate: secondHandWinRate + '%',
            totalBPChange: totalBPChange,
            averageBPChange: (totalBPChange / segmentBattles.length).toFixed(1),
            analysisDate: new Date().toISOString()
        };
    }

    // ç”Ÿæˆåˆ†çµ„è®Šå‹•å»ºè­°
    generateRankChangeRecommendations(rankChanges) {
        if (rankChanges.length === 0) {
            return ['å»ºè­°ä½¿ç”¨ ğŸ“Œ æŒ‰éˆ•æ¨™è¨˜é‡è¦çš„åˆ†çµ„è®Šå‹•ï¼Œä»¥å”åŠ©æ”¹é€²ç®—æ³•'];
        }

        const recommendations = [];
        
        // åˆ†æå‡ç´šæ¨¡å¼
        const upgrades = rankChanges.filter(change => change.changeType === 'upgrade');
        if (upgrades.length > 0) {
            recommendations.push('ç™¼ç¾ ' + upgrades.length + ' æ¬¡å‡ç´šè¨˜éŒ„ï¼Œé€™å°æ”¹é€²å‡ç´šç®—æ³•éå¸¸å¯¶è²´');
        }
        
        // åˆ†æé™ç´šæ¨¡å¼
        const downgrades = rankChanges.filter(change => change.changeType === 'downgrade');
        if (downgrades.length > 0) {
            recommendations.push('ç™¼ç¾ ' + downgrades.length + ' æ¬¡é™ç´šè¨˜éŒ„ï¼Œæœ‰åŠ©æ–¼äº†è§£é™ç´šæ¢ä»¶');
        }

        recommendations.push('è«‹å°‡æ­¤åˆ†ææ•¸æ“šåˆ†äº«åˆ° GitHub Issuesï¼Œå”åŠ©ç¤¾ç¾¤æ”¹é€²åˆ†çµ„ç®—æ³•');
        
        return recommendations;
    }

    // ä¸‹è¼‰ JSON æª”æ¡ˆçš„é€šç”¨æ–¹æ³•
    downloadJSON(data, filename) {
        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        URL.revokeObjectURL(url);
    }

    // æ›´æ–°HTMLå…ƒç´ å…§å®¹çš„é€šç”¨æ–¹æ³•
    updateElement(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = value;
        } else {
            console.warn(`Element with ID "${elementId}" not found`);
        }
    }

    // ç¶å®šäº‹ä»¶è™•ç†å™¨
    bindEvents() {
        // BP è¼¸å…¥æ¡† Enter éµæäº¤
        const bpChangeInput = document.getElementById('bpChange');
        if (bpChangeInput) {
            bpChangeInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    this.addBattle();
                }
            });
        }

        // æª”æ¡ˆåŒ¯å…¥è™•ç†
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.addEventListener('change', (event) => {
                this.importFromFile(event);
            });
        }

        // æ‹–æ‹½å€åŸŸäº‹ä»¶
        const importArea = document.getElementById('importArea');
        if (importArea) {
            importArea.addEventListener('dragover', (event) => {
                event.preventDefault();
                importArea.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
            });

            importArea.addEventListener('dragleave', (event) => {
                event.preventDefault();
                importArea.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            });

            importArea.addEventListener('drop', (event) => {
                event.preventDefault();
                importArea.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                
                const files = event.dataTransfer.files;
                if (files.length > 0) {
                    const mockEvent = { target: { files: files } };
                    this.importFromFile(mockEvent);
                }
            });
        }
    }

    // æª”æ¡ˆåŒ¯å…¥åŠŸèƒ½
    importFromFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.type === 'application/json') {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    this.processImportedData(data);
                } catch (error) {
                    alert('JSON æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
        } else {
            alert('åƒ…æ”¯æ´ JSON æ ¼å¼çš„æª”æ¡ˆ');
        }
    }

    // è™•ç†åŒ¯å…¥çš„æ•¸æ“š
    processImportedData(data) {
        try {
            if (data.battleData && Array.isArray(data.battleData)) {
                if (confirm(`ç¢ºå®šè¦åŒ¯å…¥ ${data.battleData.length} ç­†å°æˆ°è¨˜éŒ„å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰æ•¸æ“šã€‚`)) {
                    dataManager.battleData = data.battleData;
                    if (data.startingBP) dataManager.startingBP = data.startingBP;
                    if (data.currentGroup) dataManager.currentGroup = data.currentGroup;
                    if (data.playerData) dataManager.playerData = { ...dataManager.playerData, ...data.playerData };
                    if (data.rankChanges) dataManager.rankChangeHistory = data.rankChanges;
                    
                    dataManager.saveBattleData();
                    this.updateStats();
                    this.renderBattles();
                    alert('æ•¸æ“šåŒ¯å…¥æˆåŠŸï¼');
                }
            } else {
                alert('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œç¼ºå°‘æœ‰æ•ˆçš„å°æˆ°æ•¸æ“š');
            }
        } catch (error) {
            alert('æ•¸æ“šè™•ç†éŒ¯èª¤ï¼š' + error.message);
        }
    }

    // æ¸…é™¤æ‰€æœ‰æ•¸æ“š
    clearAllData() {
        if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
            dataManager.clearAllData();
            this.updateStats();
            this.renderBattles();
            alert('æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤');
        }
    }

    // çŸ©é™£é¡å‹åˆ‡æ›
    showMatrixType(type) {
        const firstBtn = document.getElementById('firstMatrixBtn');
        const secondBtn = document.getElementById('secondMatrixBtn');
        
        if (firstBtn && secondBtn) {
            firstBtn.classList.toggle('active', type === 'first');
            secondBtn.classList.toggle('active', type === 'second');
        }
        
        this.renderMatrix(type);
    }

    // åˆ‡æ›åˆ†çµ„è®Šå‹•æ¨™è¨˜
    toggleRankChange(battleIndex, battleId) {
        const isMarked = dataManager.rankChangeHistory.some(change => change.battleId === battleId);
        
        if (isMarked) {
            // ç§»é™¤æ¨™è¨˜
            dataManager.rankChangeHistory = dataManager.rankChangeHistory.filter(change => change.battleId !== battleId);
        } else {
            // æ·»åŠ æ¨™è¨˜
            const battle = dataManager.battleData[battleIndex];
            if (battle) {
                const changeType = prompt('è«‹é¸æ“‡åˆ†çµ„è®Šå‹•é¡å‹ï¼š\n1. upgrade (å‡ç´š)\n2. downgrade (é™ç´š)\n3. maintain (ä¿æŒ)', 'upgrade');
                if (changeType && ['upgrade', 'downgrade', 'maintain'].includes(changeType)) {
                    dataManager.rankChangeHistory.push({
                        battleId: battleId,
                        battleIndex: battleIndex,
                        changeType: changeType,
                        timestamp: new Date().toISOString(),
                        beforeBP: battle.bpChange < 0 ? dataManager.getStatistics().currentBP - battle.bpChange : dataManager.getStatistics().currentBP,
                        afterBP: dataManager.getStatistics().currentBP,
                        notes: `${battle.myClass} vs ${battle.opponentClass} (${battle.result})`
                    });
                }
            }
        }
        
        dataManager.saveRankChangeHistory();
        this.renderBattles();
    }

    // ç·¨è¼¯å°æˆ°è¨˜éŒ„
    editBattle(battleId) {
        const battle = dataManager.battleData.find(b => b.id === battleId);
        if (!battle) return;

        const newResult = prompt('ä¿®æ”¹å°æˆ°çµæœ (å‹/è² ):', battle.result);
        if (newResult && ['å‹', 'è² '].includes(newResult)) {
            battle.result = newResult;
            dataManager.saveBattleData();
            this.updateStats();
            this.renderBattles();
        }
    }

    // åˆªé™¤å°æˆ°è¨˜éŒ„
    deleteBattle(battleId) {
        if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†å°æˆ°è¨˜éŒ„å—ï¼Ÿ')) {
            dataManager.battleData = dataManager.battleData.filter(b => b.id !== battleId);
            // åŒæ™‚ç§»é™¤ç›¸é—œçš„åˆ†çµ„è®Šå‹•æ¨™è¨˜
            dataManager.rankChangeHistory = dataManager.rankChangeHistory.filter(change => change.battleId !== battleId);
            dataManager.saveBattleData();
            dataManager.saveRankChangeHistory();
            this.updateStats();
            this.renderBattles();
        }
    }

    // ç©å®¶è³‡æ–™ç·¨è¼¯æ–¹æ³•
    editPlayerName() {
        const current = dataManager.playerData.playerName || 'æœªè¨­å®š';
        const newValue = prompt('è«‹è¼¸å…¥ç©å®¶åç¨±:', current);
        if (newValue !== null) {
            dataManager.playerData.playerName = newValue;
            dataManager.savePlayerData();
            this.initPlayerData();
        }
    }

    editGameId() {
        const current = dataManager.playerData.gameId || 'æœªè¨­å®š';
        const newValue = prompt('è«‹è¼¸å…¥éŠæˆ²ID:', current);
        if (newValue !== null) {
            dataManager.playerData.gameId = newValue;
            dataManager.savePlayerData();
            this.initPlayerData();
        }
    }

    editMainClass() {
        const classes = ['çš‡', 'æ£®', 'é¾', 'æ­»', 'è¡€', 'å¾©', 'å¦–'];
        const current = dataManager.playerData.mainClass || 'é¾';
        const newValue = prompt('è«‹é¸æ“‡ä¸»è¦è·æ¥­ (' + classes.join('/') + '):', current);
        if (newValue && classes.includes(newValue)) {
            dataManager.playerData.mainClass = newValue;
            dataManager.savePlayerData();
            this.initPlayerData();
        }
    }

    editTargetRank() {
        const ranks = Object.keys(GROUP_DATA);
        const current = dataManager.playerData.targetRank || 'é‘½çŸ³';
        const newValue = prompt('è«‹é¸æ“‡ç›®æ¨™åˆ†çµ„ (' + ranks.join('/') + '):', current);
        if (newValue && ranks.includes(newValue)) {
            dataManager.playerData.targetRank = newValue;
            dataManager.savePlayerData();
            this.initPlayerData();
        }
    }

    // æ¸²æŸ“å°æˆ°çŸ©é™£
    renderMatrix() {
        const matrixData = dataManager.getMatrixStatistics();

        // æ¸²æŸ“å…ˆæ‰‹çŸ©é™£
        this.renderMatrixTable('firstMatrixTable', matrixData.first, 'å…ˆæ‰‹');
        this.renderMatrixStats('firstMatrixStats', matrixData.first, 'å…ˆæ‰‹');

        // æ¸²æŸ“å¾Œæ‰‹çŸ©é™£
        this.renderMatrixTable('secondMatrixTable', matrixData.second, 'å¾Œæ‰‹');
        this.renderMatrixStats('secondMatrixStats', matrixData.second, 'å¾Œæ‰‹');
    }

    // æ¸²æŸ“çŸ©é™£è¡¨æ ¼
    renderMatrixTable(tableId, matrixData, turnType) {
        const container = document.getElementById(tableId);
        if (!container) return;

        let html = '<table class="matrix-table-content">';

        // è¡¨é ­
        html += '<thead><tr><th class="matrix-header-corner">æˆ‘æ–¹\\å°æ‰‹</th>';
        CLASS_LIST.forEach(opponentClass => {
            html += `<th class="matrix-header">${opponentClass}</th>`;
        });
        html += '</tr></thead>';

        // è¡¨èº«
        html += '<tbody>';
        CLASS_LIST.forEach(myClass => {
            html += `<tr><td class="matrix-row-header">${myClass}</td>`;
            CLASS_LIST.forEach(opponentClass => {
                const data = matrixData[myClass][opponentClass];
                const winRate = data.winRate;
                const total = data.total;

                let cellClass = 'matrix-cell';
                let displayValue = '--';

                if (total > 0) {
                    displayValue = `${winRate}%`;
                    if (winRate >= 70) {
                        cellClass += ' high-winrate';
                    } else if (winRate >= 50) {
                        cellClass += ' medium-winrate';
                    } else {
                        cellClass += ' low-winrate';
                    }
                }

                html += `<td class="${cellClass}" title="${myClass} vs ${opponentClass} (${turnType}): ${data.wins}å‹/${total}å ´">${displayValue}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table>';

        container.innerHTML = html;
    }

    // æ¸²æŸ“çŸ©é™£çµ±è¨ˆä¿¡æ¯
    renderMatrixStats(statsId, matrixData, turnType) {
        const container = document.getElementById(statsId);
        if (!container) return;

        let totalGames = 0;
        let totalWins = 0;
        let bestMatchups = [];
        let worstMatchups = [];

        // è¨ˆç®—çµ±è¨ˆ
        CLASS_LIST.forEach(myClass => {
            CLASS_LIST.forEach(opponentClass => {
                const data = matrixData[myClass][opponentClass];
                if (data.total > 0) {
                    totalGames += data.total;
                    totalWins += data.wins;

                    if (data.total >= 3) { // è‡³å°‘3å ´æ‰ç´å…¥æœ€ä½³/æœ€å·®çµ±è¨ˆ
                        const matchup = {
                            vs: `${myClass} vs ${opponentClass}`,
                            winRate: data.winRate,
                            record: `${data.wins}å‹/${data.total}å ´`
                        };

                        if (data.winRate >= 70) {
                            bestMatchups.push(matchup);
                        } else if (data.winRate < 40) {
                            worstMatchups.push(matchup);
                        }
                    }
                }
            });
        });

        const overallWinRate = totalGames > 0 ? Math.round((totalWins / totalGames) * 100) : 0;

        // æ’åº
        bestMatchups.sort((a, b) => b.winRate - a.winRate);
        worstMatchups.sort((a, b) => a.winRate - b.winRate);

        let html = `
            <div class="matrix-stats-content">
                <h4>${turnType}æ•´é«”çµ±è¨ˆ</h4>
                <p>ç¸½å ´æ¬¡ï¼š${totalGames}å ´ | ç¸½å‹ç‡ï¼š${overallWinRate}%</p>
        `;

        if (bestMatchups.length > 0) {
            html += `
                <div class="matchup-section">
                    <h5 style="color: #4CAF50;">ğŸ”¥ å„ªå‹¢å°æˆ° (â‰¥70%)</h5>
                    <ul>
            `;
            bestMatchups.slice(0, 5).forEach(matchup => {
                html += `<li>${matchup.vs}: ${matchup.winRate}% (${matchup.record})</li>`;
            });
            html += '</ul></div>';
        }

        if (worstMatchups.length > 0) {
            html += `
                <div class="matchup-section">
                    <h5 style="color: #F44336;">âš ï¸ åŠ£å‹¢å°æˆ° (<40%)</h5>
                    <ul>
            `;
            worstMatchups.slice(0, 5).forEach(matchup => {
                html += `<li>${matchup.vs}: ${matchup.winRate}% (${matchup.record})</li>`;
            });
            html += '</ul></div>';
        }

        html += '</div>';
        container.innerHTML = html;
    }

    // é¡¯ç¤ºToastè¨Šæ¯
    showToast(message, type = 'info') {
        // ç§»é™¤ç¾æœ‰çš„toast
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
            existingToast.remove();
        }

        // å‰µå»ºæ–°çš„toast
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;

        // æ·»åŠ åˆ°é é¢
        document.body.appendChild(toast);

        // é¡¯ç¤ºå‹•ç•«
        setTimeout(() => {
            toast.classList.add('show');
        }, 100);

        // è‡ªå‹•éš±è—
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }, 3000);
    }

    // é¡¯ç¤ºä¿å­˜ç‹€æ…‹
    showSaveStatus(message, color) {
        this.showToast(message, color.includes('4caf50') ? 'success' : color.includes('f44336') ? 'error' : 'info');
    }
}


    </script>
    <script src="src/js/data-manager.js"></script>
    <script src="src/js/rank-manager.js"></script>
    <script src="src/js/ui-controller.js"></script>
    
    <!-- åˆå§‹åŒ–è…³æœ¬ -->
    <script>
        // å…¨åŸŸè®Šæ•¸è²æ˜
        let dataManager;
        let uiController;
        
        // ç¢ºä¿æ‰€æœ‰æ¨¡çµ„è¼‰å…¥å¾Œå†åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...');
            
            try {
                // æª¢æŸ¥ä¾è³´
                if (typeof CONFIG === 'undefined') {
                    throw new Error('CONFIG æœªè¼‰å…¥');
                }
                if (typeof DataManager === 'undefined') {
                    throw new Error('DataManager é¡åˆ¥æœªè¼‰å…¥');
                }
                if (typeof UIController === 'undefined') {
                    throw new Error('UIController é¡åˆ¥æœªè¼‰å…¥');
                }
                
                console.log('âœ… æ‰€æœ‰ä¾è³´å·²è¼‰å…¥');
                
                // åˆå§‹åŒ– DataManager
                dataManager = new DataManager();
                console.log('âœ… DataManager åˆå§‹åŒ–æˆåŠŸ');
                
                // åˆå§‹åŒ– UIController
                uiController = new UIController();
                console.log('âœ… UIController åˆå§‹åŒ–æˆåŠŸ');
                
                // è¨­å®šé è¨­é¢æ¿
                setTimeout(() => {
                    if (uiController && typeof uiController.showPanel === 'function') {
                        uiController.showPanel('stats');
                        console.log('âœ… é è¨­é¢æ¿è¨­å®šå®Œæˆ');
                    }
                }, 100);
                
                console.log('ğŸ‰ æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆï¼');
                
            } catch (error) {
                console.error('âŒ æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—:', error);
                document.body.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #f44336; background: #1a1a2e; min-height: 100vh;">
                        <h1>ğŸš« æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—</h1>
                        <p><strong>éŒ¯èª¤:</strong> ${error.message}</p>
                        <p>è«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°ç²å–è©³ç´°è³‡è¨Šã€‚</p>
                        <button onclick="window.location.reload()" style="padding: 10px 20px; margin: 10px; background: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            é‡æ–°è¼‰å…¥é é¢
                        </button>
                        <button onclick="window.open('diagnostic.html', '_blank')" style="padding: 10px 20px; margin: 10px; background: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            é–‹å•Ÿè¨ºæ–·é é¢
                        </button>
                    </div>
                `;
            }
        });
        
        // å…¨åŸŸå‡½æ•¸ (ä¾› HTML onclick ä½¿ç”¨)
        function showPanel(panelName) {
            console.log('showPanel è¢«èª¿ç”¨:', panelName);
            if (uiController && typeof uiController.showPanel === 'function') {
                uiController.showPanel(panelName);
            } else {
                console.error('uiController å°šæœªåˆå§‹åŒ–æˆ– showPanel æ–¹æ³•ä¸å­˜åœ¨');
                alert('ç³»çµ±å°šæœªå®Œå…¨è¼‰å…¥ï¼Œè«‹ç¨å€™å†è©¦');
            }
        }
        
        function addBattle() {
            if (uiController && typeof uiController.addBattle === 'function') {
                uiController.addBattle();
            } else {
                console.error('uiController å°šæœªåˆå§‹åŒ–');
            }
        }
        
        function clearAllData() {
            if (uiController && typeof uiController.clearAllData === 'function') {
                uiController.clearAllData();
            } else {
                console.error('uiController å°šæœªåˆå§‹åŒ–');
            }
        }
        
        function exportData() {
            if (uiController && typeof uiController.exportData === 'function') {
                uiController.exportData();
            } else {
                console.error('uiController å°šæœªåˆå§‹åŒ–');
            }
        }
        
        function exportRankChangeAnalysis() {
            if (uiController && typeof uiController.exportRankAnalysis === 'function') {
                uiController.exportRankAnalysis();
            } else {
                console.error('uiController å°šæœªåˆå§‹åŒ–æˆ– exportRankAnalysis æ–¹æ³•ä¸å­˜åœ¨');
            }
        }
        
        function exportPlayerProfile() {
            if (uiController && typeof uiController.exportData === 'function') {
                uiController.exportData();
            } else {
                console.error('uiController å°šæœªåˆå§‹åŒ–');
            }
        }
        
        function importFromFile(event) {
            if (uiController && typeof uiController.importFromFile === 'function') {
                uiController.importFromFile(event);
            } else {
                console.error('uiController å°šæœªåˆå§‹åŒ–');
            }
        }
        
        // å…¶ä»–å¿…è¦çš„å…¨åŸŸå‡½æ•¸
        function editStartingBP() {
            if (uiController) uiController.editStartingBP();
        }
        
        function editCurrentRank() {
            if (uiController) uiController.editCurrentRank();
        }
        
        function editPlayerName() {
            if (uiController) uiController.editPlayerName();
        }
        
        function editGameId() {
            if (uiController) uiController.editGameId();
        }
        
        function savePlayerProfile() {
            if (uiController) uiController.savePlayerProfile();
        }
        
        function resetPlayerProfile() {
            if (uiController) uiController.resetPlayerProfile();
        }
        
        function exportPlayerProfile() {
            if (uiController) uiController.exportPlayerProfile();
        }
        
        function showMatrixType(type) {
            if (uiController) uiController.showMatrixType(type);
        }
        
        function toggleRankChange(battleIndex, battleId) {
            if (uiController) uiController.toggleRankChange(battleIndex, battleId);
        }
        
        function confirmRankChange(battleIndex, battleId) {
            if (uiController) uiController.confirmRankChange(battleIndex, battleId);
        }
        
        function editBattle(battleId) {
            if (uiController) uiController.editBattle(battleId);
        }
        
        function deleteBattle(battleId) {
            if (uiController) uiController.deleteBattle(battleId);
        }
        
        function saveEditBattle(battleId) {
            if (uiController) uiController.saveEditBattle(battleId);
        }
    </script>
</body>
</html>

